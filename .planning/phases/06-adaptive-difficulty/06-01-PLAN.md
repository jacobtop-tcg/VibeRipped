---
phase: 06-adaptive-difficulty
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/difficulty.js
  - lib/config.js
  - test/difficulty.test.js
  - test/config.test.js
autonomous: true

must_haves:
  truths:
    - "Scaling function maps latency 0ms to factor 1.0 and latency 30000ms to factor 1.5"
    - "Scaling function applies user multiplier after latency factor"
    - "Final rep count is always clamped between 5 and 60 regardless of inputs"
    - "Difficulty increment advances multiplier by one step from discrete set"
    - "Difficulty decrement retreats multiplier by one step from discrete set"
    - "Multiplier at max step stays at max when incremented"
    - "Multiplier at min step stays at min when decremented"
    - "Config stores difficulty.multiplier field and defaults to 1.0"
  artifacts:
    - path: "lib/difficulty.js"
      provides: "Scaling algorithms, difficulty step logic"
      exports: ["scaleRepsForLatency", "incrementDifficulty", "decrementDifficulty", "DIFFICULTY_STEPS", "MIN_REPS", "MAX_REPS"]
    - path: "test/difficulty.test.js"
      provides: "Full test coverage for difficulty module"
      min_lines: 80
    - path: "lib/config.js"
      provides: "Extended config with difficulty.multiplier field"
      contains: "difficulty"
  key_links:
    - from: "lib/difficulty.js"
      to: "lib/config.js"
      via: "difficulty.multiplier consumed from config"
      pattern: "difficulty.*multiplier"
---

<objective>
Create the difficulty scaling module with TDD and extend configuration to store difficulty multiplier.

Purpose: Establish the core scaling algorithms (latency-to-factor lerp, user multiplier application, rep clamping) and discrete difficulty step logic that engine.js and CLI commands will consume. TDD ensures the math is correct before wiring.

Output: lib/difficulty.js with tested scaling functions, lib/config.js extended with difficulty.multiplier field
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-adaptive-difficulty/06-RESEARCH.md
@lib/config.js
@test/config.test.js
</context>

<feature>
  <name>Difficulty Scaling Module</name>
  <files>lib/difficulty.js, test/difficulty.test.js, lib/config.js, test/config.test.js</files>
  <behavior>
    Two-stage rep scaling with absolute bounds:

    scaleRepsForLatency(baseReps, latencyMs, multiplier):
    - Stage 1: Map latencyMs to scale factor via lerp (2000ms->1.0, 30000ms->1.5)
    - Stage 2: Multiply baseReps by latency factor, then by user multiplier
    - Stage 3: Clamp result to [5, 60] (MIN_REPS, MAX_REPS)
    - Returns integer (Math.round)

    Cases (scaleRepsForLatency):
    - (10, 0, 1.0) -> 10 (no latency bonus, default multiplier)
    - (10, 2000, 1.0) -> 10 (min latency = factor 1.0)
    - (10, 30000, 1.0) -> 15 (max latency = factor 1.5)
    - (10, 16000, 1.0) -> 13 (mid latency = factor ~1.25)
    - (10, 0, 2.0) -> 20 (no latency, 2x multiplier)
    - (10, 30000, 2.5) -> 38 (max latency 1.5 * 2.5 = 3.75 * 10 = 37.5 -> 38)
    - (3, 0, 1.0) -> 5 (below min, clamped up)
    - (50, 30000, 2.5) -> 60 (above max, clamped down)
    - (10, -500, 1.0) -> 10 (negative latency treated as 0/min)
    - (10, 100000, 1.0) -> 15 (latency beyond max capped at 30000)

    Discrete difficulty steps:
    DIFFICULTY_STEPS = [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0, 2.25, 2.5]

    incrementDifficulty(currentMultiplier):
    - (1.0) -> 1.25
    - (2.5) -> 2.5 (already at max)
    - (0.5) -> 0.75
    - (0.99) -> 1.0 (invalid value resets to default, then no increment since test expects reset)

    decrementDifficulty(currentMultiplier):
    - (1.0) -> 0.75
    - (0.5) -> 0.5 (already at min)
    - (2.5) -> 2.25
    - (0.99) -> 1.0 (invalid value resets to default)

    getDifficultyLabel(multiplier):
    - (1.0) -> "1.0x (default)"
    - (0.5) -> "0.5x (easiest)"
    - (2.5) -> "2.5x (hardest)"
    - (1.5) -> "1.5x"

    Config extension:
    - DEFAULT_CONFIG gains difficulty: { multiplier: 1.0 }
    - loadConfig normalizes difficulty field (fills missing with defaults)
    - validateConfig accepts difficulty field (optional, must be object with numeric multiplier)
    - Existing equipment config behavior unchanged
  </behavior>
  <implementation>
    lib/difficulty.js:
    - Export constants: DIFFICULTY_STEPS, MIN_REPS (5), MAX_REPS (60), MIN_LATENCY (2000), MAX_LATENCY (30000), MIN_FACTOR (1.0), MAX_FACTOR (1.5)
    - Internal functions: lerp(start, end, t), clamp(value, min, max), latencyToScaleFactor(latencyMs)
    - Exported functions: scaleRepsForLatency(baseReps, latencyMs, multiplier), incrementDifficulty(currentMultiplier), decrementDifficulty(currentMultiplier), getDifficultyLabel(multiplier)

    lib/config.js modifications:
    - Add difficulty: { multiplier: 1.0 } to DEFAULT_CONFIG
    - In loadConfig normalization block, add: difficulty: { multiplier: config.difficulty?.multiplier ?? 1.0 }
    - In validateConfig, add: if config.difficulty exists, verify it's an object and multiplier (if present) is a number
    - Preserve all existing behavior (equipment validation, fail-safe defaults)

    test/config.test.js additions:
    - Add tests for difficulty field in DEFAULT_CONFIG
    - Add tests for loadConfig normalizing missing difficulty field
    - Add tests for validateConfig accepting/rejecting difficulty field
  </implementation>
</feature>

<verification>
Run `node --test test/difficulty.test.js` - all tests pass
Run `node --test test/config.test.js` - all existing + new tests pass
Run `node --test` - full test suite passes (no regressions)
</verification>

<success_criteria>
- lib/difficulty.js exports scaleRepsForLatency, incrementDifficulty, decrementDifficulty, getDifficultyLabel, DIFFICULTY_STEPS, MIN_REPS, MAX_REPS
- All test cases from behavior section pass
- Config loads with difficulty.multiplier defaulting to 1.0
- Existing config tests still pass (no regressions)
- Rep counts always within [5, 60] for any combination of inputs
</success_criteria>

<output>
After completion, create `.planning/phases/06-adaptive-difficulty/06-01-SUMMARY.md`
</output>
