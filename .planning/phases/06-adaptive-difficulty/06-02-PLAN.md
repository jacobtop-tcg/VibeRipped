---
phase: 06-adaptive-difficulty
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - engine.js
  - statusline.js
  - lib/cli/commands/harder.js
  - lib/cli/commands/softer.js
  - bin/vibripped.js
  - test/engine.test.js
  - test/cli/difficulty.test.js
autonomous: true

must_haves:
  truths:
    - "Engine applies difficulty scaling to exercise reps before returning result"
    - "Statusline extracts latencyMs from stdin JSON and passes to engine"
    - "vibripped harder increments difficulty multiplier and persists to config"
    - "vibripped softer decrements difficulty multiplier and persists to config"
    - "Difficulty changes persist across sessions via configuration.json"
    - "Rep scaling stays within 5-60 bounds in all contexts"
  artifacts:
    - path: "engine.js"
      provides: "Difficulty-scaled exercise reps"
      contains: "scaleRepsForLatency"
    - path: "statusline.js"
      provides: "Latency pass-through to engine"
      contains: "latencyMs"
    - path: "lib/cli/commands/harder.js"
      provides: "Increment difficulty CLI command"
      exports: ["harderHandler"]
    - path: "lib/cli/commands/softer.js"
      provides: "Decrement difficulty CLI command"
      exports: ["softerHandler"]
    - path: "bin/vibripped.js"
      provides: "CLI registration for harder/softer commands"
      contains: "harder"
    - path: "test/cli/difficulty.test.js"
      provides: "CLI integration tests for harder/softer"
      min_lines: 40
  key_links:
    - from: "statusline.js"
      to: "engine.js"
      via: "latencyMs option passed to trigger()"
      pattern: "latencyMs"
    - from: "engine.js"
      to: "lib/difficulty.js"
      via: "scaleRepsForLatency call"
      pattern: "scaleRepsForLatency"
    - from: "engine.js"
      to: "lib/config.js"
      via: "loadConfig for difficulty.multiplier"
      pattern: "difficulty.*multiplier"
    - from: "lib/cli/commands/harder.js"
      to: "lib/difficulty.js"
      via: "incrementDifficulty call"
      pattern: "incrementDifficulty"
    - from: "lib/cli/commands/softer.js"
      to: "lib/difficulty.js"
      via: "decrementDifficulty call"
      pattern: "decrementDifficulty"
---

<objective>
Wire difficulty scaling into the engine, pass latency from statusline, and add harder/softer CLI commands.

Purpose: Connect the difficulty module (from Plan 01) into the production pipeline so that exercise reps scale based on latency and user-controlled multiplier, and users can adjust difficulty via CLI.

Output: engine.js applies scaling, statusline.js passes latency, harder/softer commands work, all tests pass
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-adaptive-difficulty/06-RESEARCH.md
@.planning/phases/06-adaptive-difficulty/06-01-SUMMARY.md
@engine.js
@statusline.js
@bin/vibripped.js
@lib/cli/commands/config.js
@lib/cli/output.js
@test/engine.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Engine and statusline integration with difficulty scaling</name>
  <files>engine.js, statusline.js, test/engine.test.js</files>
  <action>
    Modify engine.js trigger() function to apply difficulty scaling:
    1. Add require for scaleRepsForLatency from './lib/difficulty'
    2. Accept new option: options.latencyMs (number, default 0)
    3. After getNextExercise() call (line ~191), before returning result:
       - Load config: const config = loadConfig(configPath) (already available from line ~71 in config-driven mode; for legacy mode, load it fresh)
       - Get multiplier: const multiplier = config.difficulty?.multiplier || 1.0
       - Get latencyMs: const latencyMs = options.latencyMs || 0
       - Scale reps: exercise.reps = scaleRepsForLatency(exercise.reps, latencyMs, multiplier)
    4. The formatPrompt call on line ~210 already uses exercise.reps, so scaled reps flow through automatically
    5. For cooldown responses showing lastExercise, also apply scaling to lastExercise.reps so the displayed exercise shows scaled reps
    6. IMPORTANT: Do NOT mutate the pool array's exercise objects. Clone the exercise before scaling: const exercise = { ...rawExercise } where rawExercise comes from getNextExercise

    Modify statusline.js to pass latency to engine:
    1. After parseStdin and isProcessing checks, extract latency: const latencyMs = data?.cost?.total_api_duration_ms || 0
    2. Pass to trigger: const result = trigger(null, { bypassCooldown, latencyMs })
    3. That's it - engine handles the rest

    Add engine tests in test/engine.test.js:
    - Test that trigger with latencyMs option produces scaled reps (use a known pool with known base reps, verify reps differ from base when latencyMs > 2000)
    - Test that trigger with latencyMs=0 produces base reps (no scaling beyond multiplier)
    - Test that reps are clamped within bounds (use extreme latencyMs + high multiplier via config)
    - Use existing test patterns: isolated HOME dir, bypassCooldown, explicit pool for backward compat tests
  </action>
  <verify>
    Run `node --test test/engine.test.js` - all existing + new tests pass
    Run `node --test test/statusline.test.js` - existing tests still pass (statusline changes are minimal, no regression)
  </verify>
  <done>
    Engine returns scaled reps when latencyMs > 0 or difficulty multiplier != 1.0. Statusline extracts and passes latency from stdin JSON. All engine and statusline tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Harder and softer CLI commands with tests</name>
  <files>lib/cli/commands/harder.js, lib/cli/commands/softer.js, bin/vibripped.js, test/cli/difficulty.test.js</files>
  <action>
    Create lib/cli/commands/harder.js:
    - Follow existing pattern from lib/cli/commands/config.js (path.join(__dirname, ...) requires, output helpers)
    - Import: loadConfig, saveConfig, getConfigPath from '../../config'
    - Import: incrementDifficulty, getDifficultyLabel from '../../difficulty'
    - Import: success, info from '../output'
    - Function harderHandler():
      1. const configPath = getConfigPath()
      2. const config = loadConfig(configPath)
      3. const currentMultiplier = config.difficulty?.multiplier || 1.0
      4. const newMultiplier = incrementDifficulty(currentMultiplier)
      5. If newMultiplier === currentMultiplier: info('Already at maximum difficulty: ' + getDifficultyLabel(currentMultiplier)), return
      6. Ensure config.difficulty exists: if (!config.difficulty) config.difficulty = {}
      7. config.difficulty.multiplier = newMultiplier
      8. saveConfig(configPath, config)
      9. success('Difficulty increased: ' + getDifficultyLabel(currentMultiplier) + ' -> ' + getDifficultyLabel(newMultiplier))
      10. process.exitCode = 0
    - module.exports = harderHandler

    Create lib/cli/commands/softer.js:
    - Same structure as harder.js but uses decrementDifficulty
    - Message: 'Already at minimum difficulty' when at floor
    - Message: 'Difficulty decreased: X -> Y' on success
    - module.exports = softerHandler

    Register commands in bin/vibripped.js:
    - Add after the test command registration (before the "show help" block):
      program.command('harder').description('Increase difficulty multiplier by one step').action(() => { const handler = require(path.join(__dirname, '../lib/cli/commands/harder.js')); handler(); })
      program.command('softer').description('Decrease difficulty multiplier by one step').action(() => { const handler = require(path.join(__dirname, '../lib/cli/commands/softer.js')); handler(); })

    Create test/cli/difficulty.test.js:
    - Follow existing pattern from test/cli/config.test.js (isolated HOME, child_process.execFileSync)
    - Test: `vibripped harder` from default (1.0x) changes config to 1.25x
    - Test: `vibripped harder` repeated from 1.0x to 1.25x to 1.5x (run twice)
    - Test: `vibripped harder` at max (2.5x) outputs "Already at maximum" message
    - Test: `vibripped softer` from default (1.0x) changes config to 0.75x
    - Test: `vibripped softer` at min (0.5x) outputs "Already at minimum" message
    - Test: `vibripped harder` then `vibripped softer` returns to original
    - Verify config file on disk has correct multiplier after each command
  </action>
  <verify>
    Run `node --test test/cli/difficulty.test.js` - all tests pass
    Run `node --test` - full test suite passes (no regressions)
    Run `node bin/vibripped.js harder` - outputs difficulty increase message
    Run `node bin/vibripped.js softer` - outputs difficulty decrease message
    Run `node bin/vibripped.js --help` - shows harder and softer commands in help
  </verify>
  <done>
    `vibripped harder` increments difficulty multiplier by one discrete step and persists to configuration.json. `vibripped softer` decrements by one step. Both commands display current and new multiplier values. Commands appear in CLI help. All tests pass including full regression suite.
  </done>
</task>

</tasks>

<verification>
1. `node --test` - full test suite passes (all phases, no regressions)
2. `node bin/vibripped.js harder` - increases difficulty from default 1.0x to 1.25x
3. `node bin/vibripped.js softer` - decreases back to 1.0x
4. `node bin/vibripped.js test` - shows exercise with current difficulty applied
5. Verify configuration.json on disk contains difficulty.multiplier after harder/softer commands
6. Engine with latencyMs=15000 produces higher reps than latencyMs=0 for same exercise
</verification>

<success_criteria>
- Engine applies two-stage scaling (latency factor * user multiplier) to all exercise reps
- Statusline extracts cost.total_api_duration_ms and passes as latencyMs to engine
- `vibripped harder` and `vibripped softer` commands work with discrete steps [0.5, 0.75, 1.0, 1.25, 1.5, 1.75, 2.0, 2.25, 2.5]
- Difficulty multiplier persists in configuration.json across sessions
- Boundary conditions handled: max/min step clamping, rep bounds [5, 60], null/0 latency
- Full test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06-adaptive-difficulty/06-02-SUMMARY.md`
</output>
