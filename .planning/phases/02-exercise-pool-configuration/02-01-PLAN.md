---
phase: 02-exercise-pool-configuration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/config.js
  - lib/pool.js
  - test/config.test.js
  - test/pool.test.js
autonomous: true

must_haves:
  truths:
    - "Configuration with all equipment false produces bodyweight-only pool"
    - "Configuration with kettlebell true includes kettlebell exercises in pool"
    - "Configuration with multiple equipment includes all matching exercises"
    - "Invalid configuration degrades to bodyweight-only defaults without crashing"
    - "Missing configuration file degrades to bodyweight-only defaults without crashing"
    - "Equipment keys are consistent between config schema and exercise database"
  artifacts:
    - path: "lib/config.js"
      provides: "Configuration schema, validation, load/save, equipment key constants"
      exports: ["EQUIPMENT_KEYS", "DEFAULT_CONFIG", "validateConfig", "loadConfig", "saveConfig", "getConfigPath"]
    - path: "lib/pool.js"
      provides: "Full exercise database with equipment tags, pool assembly, pool hash"
      exports: ["FULL_EXERCISE_DATABASE", "DEFAULT_POOL", "assemblePool", "computePoolHash"]
    - path: "test/config.test.js"
      provides: "Config validation and load/save tests"
    - path: "test/pool.test.js"
      provides: "Pool assembly and equipment filtering tests"
  key_links:
    - from: "lib/config.js"
      to: "lib/pool.js"
      via: "EQUIPMENT_KEYS constants used in both config schema and exercise database entries"
      pattern: "EQUIPMENT_KEYS\\."
    - from: "lib/pool.js assemblePool()"
      to: "FULL_EXERCISE_DATABASE"
      via: "array filter on equipment field matching config flags"
      pattern: "exercise\\.equipment\\.every"
---

<objective>
Create the configuration module and expand the exercise database with equipment-tagged exercises and pool assembly logic, developed via TDD.

Purpose: Establishes the foundation for equipment-aware pool configuration. Config module handles user equipment declarations with fail-safe defaults. Pool module gains a full exercise database with equipment tags and an assemblePool() function that filters exercises by available equipment. All logic is pure functions with clear I/O, ideal for TDD.

Output: lib/config.js (new), lib/pool.js (extended), test/config.test.js (new), test/pool.test.js (new)
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-exercise-pool-configuration/02-RESEARCH.md
@.planning/phases/01-core-rotation-engine/01-01-SUMMARY.md
@lib/pool.js
@lib/state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED - Write failing tests for config validation and pool assembly</name>
  <files>test/config.test.js, test/pool.test.js</files>
  <action>
Create two test files using Node.js built-in test runner (node:test), matching the pattern in test/engine.test.js.

**test/config.test.js** — Tests for lib/config.js:

1. "EQUIPMENT_KEYS contains all four equipment types" — verify EQUIPMENT_KEYS has KETTLEBELL, DUMBBELLS, PULL_UP_BAR, PARALLETTES as string values
2. "DEFAULT_CONFIG has all equipment set to false" — verify structure { equipment: { kettlebell: false, dumbbells: false, pullUpBar: false, parallettes: false } }
3. "validateConfig accepts valid config" — pass DEFAULT_CONFIG, expect true
4. "validateConfig rejects null/undefined" — pass null, undefined, expect false
5. "validateConfig rejects missing equipment field" — pass {}, expect false
6. "validateConfig rejects non-boolean equipment values" — pass { equipment: { kettlebell: "yes" } }, expect false
7. "validateConfig accepts partial equipment (missing keys treated as false)" — pass { equipment: { kettlebell: true } }, expect true
8. "loadConfig returns defaults when file missing" — pass nonexistent path, expect DEFAULT_CONFIG returned (not throw)
9. "loadConfig returns defaults when file contains invalid JSON" — write garbage to temp file, expect DEFAULT_CONFIG
10. "loadConfig returns defaults when config structure invalid" — write valid JSON with wrong structure, expect DEFAULT_CONFIG
11. "loadConfig returns valid config from file" — write valid config to temp file, read back, expect match
12. "saveConfig writes config atomically with secure permissions" — save to temp path, verify file exists, read back, verify content matches

Use createTempStateDir/cleanupTempStateDir helpers matching the pattern from test/engine.test.js (os.tmpdir + crypto.randomBytes).

**test/pool.test.js** — Tests for expanded lib/pool.js:

1. "FULL_EXERCISE_DATABASE contains bodyweight exercises" — filter for equipment: [], verify at least 5 entries
2. "FULL_EXERCISE_DATABASE contains equipment exercises" — filter for equipment.length > 0, verify entries exist for each equipment type
3. "all exercises in FULL_EXERCISE_DATABASE have required fields" — each entry has name (string), reps (positive integer), equipment (array of strings)
4. "all equipment tags in database match EQUIPMENT_KEYS values" — no typos or unknown equipment strings
5. "assemblePool with no equipment returns only bodyweight exercises" — pass all-false config, verify every exercise has equipment: []
6. "assemblePool with kettlebell returns bodyweight + kettlebell exercises" — pass kettlebell: true, verify kettlebell exercises included
7. "assemblePool with all equipment returns all exercises" — pass all-true config, verify result equals FULL_EXERCISE_DATABASE
8. "assemblePool never returns empty pool" — even with empty object, returns at least bodyweight exercises
9. "assemblePool uses AND logic for multi-equipment exercises" — if any exercise requires multiple equipment, it only appears when ALL are available
10. "DEFAULT_POOL is preserved for backward compatibility" — DEFAULT_POOL still exported and unchanged from Phase 1
11. "computePoolHash produces different hashes for different pools" — assemble two different pools, verify different hashes

Tests MUST fail initially because lib/config.js does not exist yet and lib/pool.js does not export FULL_EXERCISE_DATABASE or assemblePool.

Run tests: `node --test test/config.test.js test/pool.test.js` — expect failures.
  </action>
  <verify>Run `node --test test/config.test.js test/pool.test.js 2>&1` and confirm ALL tests fail (not syntax errors — tests must parse and run, but assertions fail or imports throw because modules don't export expected functions yet).</verify>
  <done>test/config.test.js has 12 test cases, test/pool.test.js has 11 test cases, all fail on first run.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN - Implement config module and extend pool module to pass all tests</name>
  <files>lib/config.js, lib/pool.js</files>
  <action>
**Create lib/config.js** with these exports:

1. `EQUIPMENT_KEYS` — constant object mapping readable names to string keys:
   ```
   KETTLEBELL: 'kettlebell'
   DUMBBELLS: 'dumbbells'
   PULL_UP_BAR: 'pullUpBar'
   PARALLETTES: 'parallettes'
   ```

2. `DEFAULT_CONFIG` — all equipment false:
   ```
   { equipment: { kettlebell: false, dumbbells: false, pullUpBar: false, parallettes: false } }
   ```

3. `validateConfig(config)` — manual validation (no external libraries):
   - Reject null/undefined/non-object
   - Reject missing or non-object equipment field
   - Reject non-boolean equipment values for known keys
   - Accept partial configs (missing keys treated as false implicitly)
   - Return boolean

4. `loadConfig(configPath)` — load with fail-safe defaults:
   - Try readFileSync + JSON.parse
   - Validate with validateConfig
   - On any failure (ENOENT, parse error, validation failure): log to stderr, return DEFAULT_CONFIG
   - NEVER throw

5. `saveConfig(configPath, config)` — atomic write:
   - Use write-file-atomic (already a project dependency)
   - mkdirSync with mode 0o700 for directory
   - writeFileAtomic.sync with mode 0o600 for file
   - Log errors to stderr, never throw

6. `getConfigPath()` — return path joining getStateDir() from state.js with 'configuration.json'
   - Import getStateDir from ./state.js to reuse XDG logic

**Extend lib/pool.js** — add new exports while preserving all existing exports:

1. `FULL_EXERCISE_DATABASE` — array of exercises with equipment tags. Import EQUIPMENT_KEYS from config.js. Include at minimum:

   Bodyweight (equipment: []) — at least 10 exercises:
   - Pushups x15, Bodyweight squats x20, Desk pushups x15, Lunges x10, Calf raises x25, Tricep dips x12, Wall sit x30, High knees x30, Glute bridges x15, Plank x30

   Kettlebell (equipment: [EQUIPMENT_KEYS.KETTLEBELL]):
   - Kettlebell swings x15, Goblet squats x12, Kettlebell deadlifts x12, Turkish get-up x3

   Dumbbells (equipment: [EQUIPMENT_KEYS.DUMBBELLS]):
   - Dumbbell rows x12, Overhead press x10, Dumbbell curls x12, Lateral raises x12

   Pull-up bar (equipment: [EQUIPMENT_KEYS.PULL_UP_BAR]):
   - Pull-ups x8, Chin-ups x8, Hanging knee raises x10, Dead hangs x20

   Parallettes (equipment: [EQUIPMENT_KEYS.PARALLETTES]):
   - L-sit x20, Parallette pushups x12, Tuck planche x10, Parallette dips x10

   Keep exercise selection conservative (finishable quickly, low sweat, preserve cognitive ability). "reps" for isometric holds = seconds.

2. `assemblePool(equipmentConfig)` — filter FULL_EXERCISE_DATABASE:
   - Get list of available equipment keys where value === true
   - Include exercise if equipment array is empty (bodyweight) OR every required equipment is in available list (AND logic)
   - If result is empty (should never happen since bodyweight always included), fall back to DEFAULT_POOL and log to stderr
   - Return filtered array

3. Preserve existing exports: `DEFAULT_POOL` and `computePoolHash` must remain unchanged and exported.

IMPORTANT: The bodyweight entries in FULL_EXERCISE_DATABASE should be identical to the existing DEFAULT_POOL entries (same names, same reps) so that DEFAULT_POOL remains a strict subset. This preserves backward compatibility — DEFAULT_POOL is still the hard-coded fallback.

Run tests: `node --test test/config.test.js test/pool.test.js` — all must pass.
Also run existing tests: `node --test test/engine.test.js` — all must still pass (no regression).
  </action>
  <verify>Run `node --test test/config.test.js test/pool.test.js && node --test test/engine.test.js` — all tests pass (0 failures). Verify lib/config.js exists and exports EQUIPMENT_KEYS, DEFAULT_CONFIG, validateConfig, loadConfig, saveConfig, getConfigPath. Verify lib/pool.js exports FULL_EXERCISE_DATABASE, assemblePool alongside existing DEFAULT_POOL, computePoolHash.</verify>
  <done>All 23+ test cases pass. lib/config.js created. lib/pool.js extended with FULL_EXERCISE_DATABASE (26+ exercises across 5 categories) and assemblePool(). Existing engine.test.js tests still pass with zero regression.</done>
</task>

</tasks>

<verification>
1. `node --test` — all test files pass (config, pool, engine)
2. `node -e "const c = require('./lib/config'); console.log(Object.keys(c))"` — shows EQUIPMENT_KEYS, DEFAULT_CONFIG, validateConfig, loadConfig, saveConfig, getConfigPath
3. `node -e "const p = require('./lib/pool'); console.log('DB:', p.FULL_EXERCISE_DATABASE.length, 'Default:', p.DEFAULT_POOL.length)"` — DB has 26+ exercises, Default has 10
4. `node -e "const p = require('./lib/pool'); const c = require('./lib/config'); console.log('BW:', p.assemblePool(c.DEFAULT_CONFIG).length)"` — bodyweight-only pool has 10 exercises
5. `node -e "const p = require('./lib/pool'); console.log('All:', p.assemblePool({kettlebell:true,dumbbells:true,pullUpBar:true,parallettes:true}).length)"` — all-equipment pool has 26+ exercises
</verification>

<success_criteria>
- lib/config.js exists with EQUIPMENT_KEYS, DEFAULT_CONFIG, validateConfig, loadConfig, saveConfig, getConfigPath
- lib/pool.js extended with FULL_EXERCISE_DATABASE (26+ exercises) and assemblePool()
- All existing exports from lib/pool.js preserved (DEFAULT_POOL, computePoolHash)
- All existing tests pass with zero regression
- 23+ new test cases pass covering config validation, pool assembly, equipment filtering
- Invalid/missing config always degrades to bodyweight-only defaults
- Equipment keys are consistent between config.js constants and pool.js database entries
</success_criteria>

<output>
After completion, create `.planning/phases/02-exercise-pool-configuration/02-01-SUMMARY.md`
</output>
