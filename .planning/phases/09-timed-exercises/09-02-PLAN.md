---
phase: 09-timed-exercises
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - statusline.js
  - lib/cli/commands/pool.js
  - bin/vibripped.js
  - test/statusline.test.js
  - test/cli/pool.test.js
autonomous: true

must_haves:
  truths:
    - "Statusline displays timed exercises as 'Plank 30s' with type passed to formatExercise"
    - "CLI pool add supports --type timed and --duration flags for timed exercises"
    - "CLI pool list displays timed exercises as '30s' not 'x30'"
    - "Timed exercise durations scale with latency factor via existing scaleRepsForLatency"
  artifacts:
    - path: "statusline.js"
      provides: "Type-aware formatExercise calls for exercise and cooldown paths"
      contains: "exercise.type"
    - path: "lib/cli/commands/pool.js"
      provides: "Timed exercise support in add and list commands"
      contains: "type.*timed"
    - path: "bin/vibripped.js"
      provides: "Commander options for --type and --duration on pool add"
      contains: "option.*--type"
  key_links:
    - from: "statusline.js"
      to: "lib/statusline/format.js"
      via: "formatExercise(name, value, type, opts)"
      pattern: "formatExercise.*type"
    - from: "lib/cli/commands/pool.js"
      to: "pool.json"
      via: "type and duration fields in new exercise objects"
      pattern: "type.*timed.*duration"
---

<objective>
Wire timed exercise type through statusline display pipeline and CLI commands.

Purpose: Plan 01 built the type-aware formatting functions. This plan connects them to the statusline provider (so users see "Plank 30s" during processing) and extends the CLI (so users can add timed exercises via `vibripped pool add "Plank" 30 --type timed`).

Output: Complete timed exercise support end-to-end: CLI add with type/duration, statusline display, pool list formatting.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-timed-exercises/09-RESEARCH.md
@.planning/phases/09-timed-exercises/09-01-SUMMARY.md
@statusline.js
@lib/cli/commands/pool.js
@bin/vibripped.js
@test/statusline.test.js
@test/cli/pool.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire exercise type through statusline provider</name>
  <files>
    statusline.js
    test/statusline.test.js
  </files>
  <action>
    Update statusline.js to pass exercise type through to formatExercise in both code paths:

    **Exercise path (line 75 area):**
    Currently: `formatExercise(result.exercise.name, result.exercise.reps, { prefix: 'ðŸ’ª ' })`
    Change to: Extract the display value using type-aware logic, then pass type to formatExercise.
    ```javascript
    const exercise = result.exercise;
    const value = exercise.type === 'timed'
      ? (exercise.duration ?? exercise.reps)
      : exercise.reps;
    const formatted = formatExercise(exercise.name, value, exercise.type || 'reps', { prefix: 'ðŸ’ª ' });
    ```

    **Cooldown path (line 67 area):**
    Same pattern for `result.lastExercise`:
    ```javascript
    const ex = result.lastExercise;
    const value = ex.type === 'timed'
      ? (ex.duration ?? ex.reps)
      : ex.reps;
    const formatted = formatExercise(ex.name, value, ex.type || 'reps', { prefix: 'ðŸ’ª ' });
    ```

    Note: Scaling already works because engine.js clones the exercise and scales `exercise.reps` via `scaleRepsForLatency`. For timed exercises, `reps` holds the duration value which gets scaled identically. The `duration ?? reps` fallback ensures it works whether or not the `duration` field is present on the exercise.

    **Add integration test to test/statusline.test.js:**
    Add a describe block "statusline timed exercise display (integration)" that verifies the full pipeline by spawning `statusline.js` as a child process with stdin JSON containing a timed exercise pool. Use the existing integration test pattern from the file (execSync with input piped to statusline.js). Verify stdout contains "30s" not "x30" for a timed exercise.

    If integration tests are complex to set up (require pool.json with timed exercises), add a focused unit test instead: test that the value extraction logic `(type === 'timed' ? (duration ?? reps) : reps)` produces correct values for both types.
  </action>
  <verify>
    `node --test test/statusline.test.js` passes all tests.
    `node --test` passes all tests.
  </verify>
  <done>
    Statusline displays "Plank 30s" for timed exercises and "Pushups x15" for rep exercises.
    Both exercise and cooldown code paths pass type to formatExercise.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend CLI pool commands for timed exercises</name>
  <files>
    bin/vibripped.js
    lib/cli/commands/pool.js
    test/cli/pool.test.js
  </files>
  <action>
    **bin/vibripped.js** - Update `pool add` command definition to accept type and duration options:
    ```javascript
    poolCmd
      .command('add <name> <reps>')
      .description('Add exercise to pool')
      .option('--type <type>', 'Exercise type: reps or timed', 'reps')
      .option('--duration <seconds>', 'Duration in seconds (for timed exercises)')
      .action((name, reps, options) => {
        const poolHandler = require(path.join(__dirname, '../lib/cli/commands/pool.js'));
        poolHandler.add(name, reps, options);
      });
    ```

    **lib/cli/commands/pool.js** - Update `add` function:

    1. Change signature from `add(name, repsStr)` to `add(name, repsStr, options = {})`.

    2. Validate type option: if `options.type` is provided, must be 'reps' or 'timed'. Default to 'reps'.

    3. When type is 'timed':
       - Add exercise with `type: "timed"` field
       - If `options.duration` provided, parse and validate as positive integer, add `duration` field
       - If no `--duration`, use reps value as duration (same number, both fields)
       - Success message: `Added "Plank" 30s to pool` (not "x30")

    4. When type is 'reps' (default):
       - Add exercise with `type: "reps"` field (or omit for backward compat - prefer explicit)
       - Success message unchanged: `Added "Pushups" x15 to pool`

    5. Update the exercise object construction:
    ```javascript
    const newExercise = {
      name: validatedName,
      reps: validatedReps,
      equipment: []
    };

    if (exerciseType === 'timed') {
      newExercise.type = 'timed';
      if (validatedDuration !== null) {
        newExercise.duration = validatedDuration;
      }
    } else {
      newExercise.type = 'reps';
    }
    ```

    **lib/cli/commands/pool.js** - Update `list` function:
    Currently displays: `${exercise.name} x${exercise.reps}`
    Change to type-aware display:
    ```javascript
    const display = exercise.type === 'timed'
      ? `${exercise.name} ${exercise.duration ?? exercise.reps}s`
      : `${exercise.name} x${exercise.reps}`;
    info(`  ${i + 1}. ${display} [${equipment}]`);
    ```

    **test/cli/pool.test.js** - Add tests:
    - Test `pool add "Plank" 30 --type timed` creates exercise with type: "timed" in pool.json
    - Test `pool add "Plank" 30 --type timed --duration 45` creates exercise with duration: 45
    - Test `pool add "Pushups" 15` still works (default type: "reps", no duration field)
    - Test `pool add "Plank" 30 --type invalid` fails with error
    - Test pool list shows timed exercises with "s" suffix (spawn `vibripped pool list` and check stdout)

    Use the existing CLI integration test pattern from the test file (isolated HOME, execSync subprocess).
  </action>
  <verify>
    `node --test test/cli/pool.test.js` passes all tests.
    `node --test` passes all tests.
    Manual verification: `node bin/vibripped.js pool add "Test plank" 30 --type timed` succeeds.
  </verify>
  <done>
    `vibripped pool add "Plank" 30 --type timed` adds a timed exercise to pool.
    `vibripped pool list` displays timed exercises as "30s" not "x30".
    `vibripped pool add "Pushups" 15` still works unchanged (backward compat).
    Type and duration options validated with clear error messages.
  </done>
</task>

</tasks>

<verification>
- `node --test` - all tests pass, zero regressions
- Statusline pipeline: timed exercises display as "Plank 30s" with ðŸ’ª prefix
- CLI: `vibripped pool add "Plank" 30 --type timed` adds timed exercise
- CLI: `vibripped pool list` shows timed exercises with "s" suffix
- Difficulty scaling: timed exercises scale via same scaleRepsForLatency (already works via reps field)
- Rotation: timed and rep exercises rotate identically in sequential order (engine unchanged)
</verification>

<success_criteria>
- Statusline shows "Plank 30s" for timed exercises during Claude Code processing
- CLI supports adding timed exercises with --type timed flag
- Pool list differentiates timed (30s) from rep (x15) exercises
- All 4 phase success criteria from ROADMAP met
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-timed-exercises/09-02-SUMMARY.md`
</output>
