---
phase: 09-timed-exercises
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/pool.js
  - lib/statusline/format.js
  - engine.js
  - test/pool.test.js
  - test/statusline.test.js
  - test/engine.test.js
autonomous: true

must_haves:
  truths:
    - "formatExercise renders timed exercises as 'Plank 30s' not 'Plank x30'"
    - "formatExercise renders rep-based exercises unchanged as 'Pushups x15'"
    - "validateExercise accepts optional duration field (positive integer)"
    - "validateExercise rejects invalid duration values (negative, zero, non-integer)"
    - "formatPrompt renders timed exercises as 'Plank 30s' for engine CLI output"
  artifacts:
    - path: "lib/statusline/format.js"
      provides: "Type-aware formatExercise with third parameter"
      contains: "type === 'timed'"
    - path: "lib/pool.js"
      provides: "Duration field validation in validateExercise"
      contains: "exercise.duration"
    - path: "engine.js"
      provides: "Type-aware formatPrompt"
      contains: "type === 'timed'"
  key_links:
    - from: "lib/statusline/format.js"
      to: "formatExercise callers"
      via: "third parameter (type)"
      pattern: "formatExercise.*type"
    - from: "lib/pool.js"
      to: "validateExercise callers"
      via: "optional duration validation"
      pattern: "exercise\\.duration"
---

<objective>
Add type-aware display formatting and duration field validation using TDD.

Purpose: Core functions (formatExercise, validateExercise, formatPrompt) must distinguish timed from rep-based exercises before the pipeline can propagate type information.

Output: Updated formatExercise with type parameter ("Plank 30s" vs "Pushups x15"), validateExercise with optional duration field, formatPrompt with type-aware output. All backed by tests.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-timed-exercises/09-RESEARCH.md
@lib/statusline/format.js
@lib/pool.js
@engine.js
@test/statusline.test.js
@test/pool.test.js
@test/engine.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD formatExercise type-aware display + formatPrompt + duration validation</name>
  <files>
    lib/statusline/format.js
    lib/pool.js
    engine.js
    test/statusline.test.js
    test/pool.test.js
    test/engine.test.js
  </files>
  <action>
    RED phase - Add failing tests to three test files:

    **test/statusline.test.js** - Add describe block "formatExercise type-aware display":
    - `formatExercise('Plank', 30, 'timed')` returns string containing "Plank 30s" (not "x30")
    - `formatExercise('Pushups', 15, 'reps')` returns string containing "Pushups x15" (backward compat)
    - `formatExercise('Pushups', 15)` returns string containing "Pushups x15" (default type=reps when omitted)
    - `formatExercise('Wall sit', 30, 'timed', { prefix: 'ðŸ’ª ' })` returns string containing "ðŸ’ª Wall sit 30s"
    - `formatExercise('Plank', null, 'timed')` returns string containing just "Plank" (no value)

    **test/pool.test.js** - Add describe block "validateExercise duration field":
    - Exercise with `{name: "Plank", reps: 30, duration: 30}` validates true
    - Exercise with `{name: "Plank", reps: 30}` (no duration) validates true (backward compat)
    - Exercise with `{name: "Plank", reps: 30, duration: -5}` validates false
    - Exercise with `{name: "Plank", reps: 30, duration: 0}` validates false
    - Exercise with `{name: "Plank", reps: 30, duration: 30.5}` validates false (non-integer)
    - Exercise with `{name: "Plank", reps: 30, duration: "30"}` validates false (string, not number)

    **test/engine.test.js** - Add describe block "formatPrompt type-aware":
    - Import or access formatPrompt (may need to export it from engine.js)
    - `formatPrompt({name: "Plank", reps: 30, type: "timed"})` returns "Plank 30s"
    - `formatPrompt({name: "Pushups", reps: 15, type: "reps"})` returns "Pushups x15"
    - `formatPrompt({name: "Pushups", reps: 15})` returns "Pushups x15" (no type = default reps)

    Run `node --test test/statusline.test.js test/pool.test.js test/engine.test.js` - tests MUST fail.

    GREEN phase - Implement minimal code to pass:

    **lib/statusline/format.js** - Update formatExercise signature from `(name, reps, options)` to `(name, value, type, options)`. IMPORTANT: Handle backward compatibility - if third argument is an object (not a string), treat it as options with type defaulting to 'reps'. This prevents breaking any existing callers that pass `(name, reps, { prefix })` without a type.
    ```javascript
    function formatExercise(name, value, typeOrOptions, options) {
      // Backward compat: if third arg is object, it's options (old signature)
      let type = 'reps';
      let opts = {};
      if (typeof typeOrOptions === 'object' && typeOrOptions !== null) {
        opts = typeOrOptions;
      } else if (typeof typeOrOptions === 'string') {
        type = typeOrOptions;
        opts = options || {};
      }
      // ... format based on type
      // type === 'timed' ? `${value}s` : `x${value}`
    }
    ```

    **lib/pool.js** - Add duration validation in validateExercise after the environments block:
    ```javascript
    // Optional: duration (positive integer, only validated if present)
    if (exercise.duration !== undefined) {
      if (!Number.isInteger(exercise.duration) || exercise.duration <= 0) {
        return false;
      }
    }
    ```

    **engine.js** - Update formatPrompt to be type-aware:
    ```javascript
    function formatPrompt(exercise) {
      if (exercise.type === 'timed') {
        return `${exercise.name} ${exercise.reps}s`;
      }
      return `${exercise.name} x${exercise.reps}`;
    }
    ```
    Export formatPrompt from engine.js module.exports alongside trigger.

    Run `node --test test/statusline.test.js test/pool.test.js test/engine.test.js` - tests MUST pass.
    Run `node --test` (all tests) - ALL existing tests MUST still pass (no regressions).
  </action>
  <verify>
    `node --test test/statusline.test.js test/pool.test.js test/engine.test.js` passes all new tests.
    `node --test` passes ALL tests (new + existing, zero regressions).
  </verify>
  <done>
    formatExercise renders "Plank 30s" for timed and "Pushups x15" for reps.
    validateExercise accepts optional duration (positive integer) and rejects invalid values.
    formatPrompt renders "Plank 30s" for timed exercises in engine CLI output.
    All existing tests still pass (backward compatibility preserved).
  </done>
</task>

</tasks>

<verification>
- `node --test` - all tests pass, zero regressions
- `formatExercise('Plank', 30, 'timed')` contains "30s"
- `formatExercise('Pushups', 15, 'reps')` contains "x15"
- `formatExercise('Pushups', 15, { prefix: 'ðŸ’ª ' })` still works (backward compat)
</verification>

<success_criteria>
- formatExercise differentiates timed ("30s") from reps ("x15") based on type parameter
- validateExercise accepts optional duration field
- formatPrompt in engine.js renders timed exercises correctly
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-timed-exercises/09-01-SUMMARY.md`
</output>
