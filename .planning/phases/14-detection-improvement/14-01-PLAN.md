---
phase: 14-detection-improvement
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/statusline/detection.js
  - lib/config.js
  - test/detection.test.js
autonomous: true

must_haves:
  truths:
    - "isProcessing returns true only when total_api_duration_ms increases above threshold between invocations"
    - "isProcessing returns false on routine statusline updates where API duration has not changed"
    - "isProcessing falls back to v1.0 token-based heuristic when cost field is missing"
    - "Detection state persists between invocations using atomic write-rename pattern"
    - "Session restart resets detection state deltas without triggering false positive"
    - "Sensitivity threshold is configurable via config.detection.sensitivity (strict/normal/relaxed)"
  artifacts:
    - path: "lib/statusline/detection.js"
      provides: "Delta-based API detection with fallback and configurable sensitivity"
      exports: ["isProcessing"]
    - path: "lib/config.js"
      provides: "Detection config validation and defaults"
      contains: "detection"
    - path: "test/detection.test.js"
      provides: "Comprehensive detection unit tests"
      min_lines: 80
  key_links:
    - from: "lib/statusline/detection.js"
      to: "~/.config/viberipped/detection-state.json"
      via: "atomic write-rename state persistence"
      pattern: "renameSync"
    - from: "lib/statusline/detection.js"
      to: "lib/config.js"
      via: "sensitivity threshold lookup"
      pattern: "detection\\.sensitivity"
---

<objective>
Implement delta-based API detection that replaces the v1.0 token-accumulation heuristic with total_api_duration_ms tracking, eliminating false positives on routine statusline updates.

Purpose: The v1.0 detection triggers on every statusline update after the first API call because `current_usage.input_tokens > 0` remains true for the entire session. This plan implements a delta tracker that only triggers when `cost.total_api_duration_ms` increases, meaning an actual API call occurred.

Output: Working detection logic with tests, config integration, and v1.0 fallback.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-detection-improvement/14-RESEARCH.md
@lib/statusline/detection.js
@lib/config.js
@engine.js
@test/statusline.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD detection logic - tests and implementation</name>
  <files>lib/statusline/detection.js, lib/config.js, test/detection.test.js</files>
  <action>
**RED phase:** Create `test/detection.test.js` with dedicated detection tests (the existing tests in `test/statusline.test.js` will be updated in Plan 14-02). Write tests for:

1. **Delta detection (new behavior):**
   - Returns `true` when `cost.total_api_duration_ms` increases by >= threshold (default 100ms)
   - Returns `false` when `cost.total_api_duration_ms` unchanged between calls
   - Returns `false` when `cost.total_api_duration_ms` increase < threshold
   - Returns `false` on first invocation of new session (state reset)

2. **Session tracking:**
   - Resets delta tracking when `session_id` changes (new Claude Code session)
   - Returns `false` on first call after session change (no false positive on restart)
   - Handles missing `session_id` gracefully (treat as same session)

3. **Configurable sensitivity:**
   - `strict` sensitivity uses 50ms threshold
   - `normal` sensitivity uses 100ms threshold (default)
   - `relaxed` sensitivity uses 500ms threshold
   - Custom `durationThreshold` overrides sensitivity preset
   - Missing config defaults to `normal`

4. **Fallback to v1.0:**
   - Falls back to token-based heuristic when `cost` field is missing/undefined
   - Falls back when `total_api_duration_ms` is undefined
   - Fallback returns true when `input_tokens > 0` (v1.0 behavior)
   - Fallback returns false when `current_usage` is null

5. **State persistence:**
   - Detection state file written after each call
   - State loads correctly on next invocation
   - Corrupt state file resets to defaults (no crash)
   - Missing state file creates fresh state

6. **Edge cases:**
   - `null` claudeData returns false
   - `undefined` claudeData returns false
   - Empty object returns false (falls back to v1.0 which returns false for missing current_usage)

**Important test pattern:** Since `isProcessing` now has side effects (reads/writes state file), tests MUST use isolated temp directories. Set detection state path via a `statePath` option or use `VIBERIPPED_HOME` env var override. Follow the existing pattern from `test/statusline.test.js` integration tests (create tmpDir, set HOME env, cleanup).

The cleanest approach: refactor `isProcessing` to accept an optional `options` object: `isProcessing(claudeData, options)` where `options.config` provides detection config and `options.statePath` provides detection state file location. This keeps the function testable without env var hacks.

**GREEN phase:** Implement in `lib/statusline/detection.js`:

```javascript
// isProcessing(claudeData, options = {})
// options.config: { detection: { sensitivity, durationThreshold, fallbackOnError } }
// options.statePath: path to detection-state.json (default: ~/.config/viberipped/detection-state.json)
```

Core logic:
1. If `claudeData.cost?.total_api_duration_ms !== undefined` -> use delta detection
2. Load detection state from `options.statePath` (or default path)
3. Compare `session_id` - if changed, reset state, return false
4. Calculate duration delta = current - previous
5. Get threshold from config sensitivity or custom durationThreshold
6. Delta >= threshold -> return true (API call detected)
7. Update state atomically (write-rename pattern from engine.js)
8. If cost field missing -> fallback to v1.0 token heuristic

Use atomic write-rename pattern: write to `${statePath}.tmp`, then `fs.renameSync`.

Also update `lib/config.js`:
- Add `detection` field to `DEFAULT_CONFIG`: `{ sensitivity: 'normal', durationThreshold: null, fallbackOnError: true }`
- Add validation for `detection` field in `validateConfig()`: object type check, sensitivity must be string if present, durationThreshold must be number if present, fallbackOnError must be boolean if present
- Include `detection` in `loadConfig()` normalization: merge with defaults, handle missing gracefully

**Sensitivity threshold mapping:**
- `strict`: 50ms
- `normal`: 100ms (default)
- `relaxed`: 500ms
- If `durationThreshold` is set (number), use that instead of sensitivity preset

Run: `node --test test/detection.test.js` - all tests must pass.
  </action>
  <verify>
    `node --test test/detection.test.js` passes all tests.
    `node --test test/config.test.js` passes (existing config tests still work with new detection field).
    `node --test` passes all tests project-wide.
  </verify>
  <done>
    isProcessing correctly detects API calls via duration delta tracking, falls back to v1.0 heuristic when cost field missing, respects configurable sensitivity, handles session restarts, and persists state atomically. Config module validates detection settings.
  </done>
</task>

</tasks>

<verification>
- `node --test test/detection.test.js` passes all new detection tests
- `node --test test/config.test.js` passes with detection field support
- `node --test` passes all tests project-wide (no regressions)
- detection.js exports `isProcessing` with backward-compatible signature
- config.js DEFAULT_CONFIG includes detection field
- Detection state uses atomic write-rename (grep for `renameSync` in detection.js)
</verification>

<success_criteria>
- Delta-based detection correctly identifies API calls (duration increase >= threshold)
- False positives eliminated (unchanged duration returns false)
- Session restart handling prevents stale delta confusion
- Configurable sensitivity with three presets and custom threshold override
- Graceful fallback to v1.0 token heuristic when cost field unavailable
- Atomic state persistence prevents corruption
- All existing tests continue passing
</success_criteria>

<output>
After completion, create `.planning/phases/14-detection-improvement/14-01-SUMMARY.md`
</output>
