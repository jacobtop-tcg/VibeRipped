---
phase: 14-detection-improvement
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - statusline.js
  - test/statusline.test.js
autonomous: false

must_haves:
  truths:
    - "statusline.js passes config and detection state path to isProcessing"
    - "Integration tests verify exercise output only when API duration increases"
    - "Integration tests verify no output when API duration is unchanged"
    - "Integration tests verify fallback behavior when cost field is absent"
    - "Live testing confirms detection accuracy in real Claude Code session"
  artifacts:
    - path: "statusline.js"
      provides: "Config-aware detection wiring"
      contains: "isProcessing"
    - path: "test/statusline.test.js"
      provides: "Updated integration tests with cost field in test JSON"
      min_lines: 100
  key_links:
    - from: "statusline.js"
      to: "lib/statusline/detection.js"
      via: "isProcessing call with config options"
      pattern: "isProcessing.*config"
    - from: "statusline.js"
      to: "lib/config.js"
      via: "loadConfig for detection settings"
      pattern: "loadConfig"
---

<objective>
Wire the improved detection logic into statusline.js and update all integration tests to use the new cost-field-based JSON format, then verify with live testing.

Purpose: Plan 14-01 built the detection logic in isolation. This plan connects it to the production entry point (statusline.js) and updates the integration test suite to validate end-to-end behavior with the new detection approach.

Output: Production-ready statusline with improved detection, updated test suite, live testing validation.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-detection-improvement/14-RESEARCH.md
@.planning/phases/14-detection-improvement/14-01-SUMMARY.md
@statusline.js
@lib/statusline/detection.js
@lib/config.js
@test/statusline.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire detection config into statusline.js and update integration tests</name>
  <files>statusline.js, test/statusline.test.js</files>
  <action>
**Update `statusline.js`:**

1. Add `loadConfig` and `getConfigPath` imports from `lib/config.js`
2. In the `end` handler, after parsing stdin JSON, load config before calling `isProcessing`:
   ```
   const config = loadConfig(getConfigPath());
   ```
3. Construct detection state path from config dir:
   ```
   const detectionStatePath = path.join(path.dirname(getConfigPath()), 'detection-state.json');
   ```
4. Pass options to `isProcessing`:
   ```
   if (!isProcessing(data, { config, statePath: detectionStatePath })) {
   ```
5. Keep the rest of statusline.js unchanged (latency extraction, engine trigger, formatting)

**Update `test/statusline.test.js` unit tests for `isProcessing`:**

The existing `isProcessing` unit tests (lines 42-79) test the v1.0 token-based heuristic. These tests now describe fallback behavior. Update the describe block:

1. Rename describe to `'isProcessing (fallback / v1.0 compatibility)'`
2. Add a note that these tests cover the fallback path (no cost field in data)
3. All existing assertions should still pass since the fallback path uses the same token-based logic
4. Add new unit tests in a `'isProcessing (delta detection)'` describe block:
   - Test with cost field present + increasing duration -> returns true
   - Test with cost field present + same duration -> returns false
   - These require temp state dir setup similar to integration tests

**Update `test/statusline.test.js` integration tests:**

The integration tests currently pipe JSON with only `context_window.current_usage`. Update them to include the `cost` field for more realistic testing:

1. For tests that expect exercise output: Use JSON with `cost.total_api_duration_ms` set to a value that will produce a delta (e.g., first call with 0 in state, then 5000 in stdin). Since each test creates a fresh tmpHome, the detection state will be empty, and the first call with `total_api_duration_ms > 0` will... actually return false (first invocation of new session resets).

   **Key insight:** The first statusline invocation in a new session returns false (session reset). To test "produces output", we need TWO invocations: first to establish baseline, second with increased duration. OR, we pre-seed the detection-state.json in the tmpDir with a known `lastApiDuration: 0` and matching `sessionId`.

   **Recommended approach:** Pre-seed `detection-state.json` in tmpHome's `.config/viberipped/` alongside pool.json and state.json. Set `sessionId` to match what's in the test's stdin JSON, and `lastApiDuration` to 0. Then the test's stdin JSON should include `session_id: "test-session"` and `cost: { total_api_duration_ms: 5000 }`, producing a delta of 5000 (well above threshold).

2. Update the existing integration test `'outputs ANSI-formatted exercise when valid processing JSON piped to stdin'`:
   - Add `cost: { total_api_duration_ms: 5000 }` and `session_id: "test-session"` to input JSON
   - Pre-seed `detection-state.json` with `{ sessionId: "test-session", lastApiDuration: 0, lastUpdate: 0 }`
   - Assertion remains the same (ANSI output with exercise format)

3. Update `'outputs empty when non-processing JSON (current_usage: null) piped to stdin'`:
   - This test should now also test "no output when API duration unchanged"
   - Add input variant: JSON with `cost: { total_api_duration_ms: 5000 }` and `session_id: "test-session"` BUT pre-seed state with `lastApiDuration: 5000` (same value = no delta)
   - Should produce empty output

4. Add new integration test: `'outputs empty on first invocation of new session (session reset)'`
   - Input: JSON with `cost: { total_api_duration_ms: 5000 }` and `session_id: "new-session"`
   - Pre-seed state with different `sessionId: "old-session"`
   - Expected: empty output (session reset returns false)

5. Add new integration test: `'falls back to v1.0 heuristic when cost field absent'`
   - Input: JSON with only `context_window.current_usage` (no cost field)
   - Expected: ANSI exercise output (v1.0 fallback triggers)

6. Keep existing timed/reps exercise integration tests working. These need the same pre-seeded detection state approach.

7. Update each integration test's input JSON to include `session_id` and `cost` fields for realism, except the fallback test which deliberately omits `cost`.
  </action>
  <verify>
    `node --test test/statusline.test.js` passes all tests (updated and new).
    `node --test` passes all tests project-wide.
  </verify>
  <done>
    statusline.js passes config to isProcessing, integration tests validate delta detection end-to-end, fallback path tested, session reset tested.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Live testing of detection accuracy</name>
  <files>statusline.js</files>
  <action>
    Verify the improved detection heuristic in a live Claude Code session. The heuristic tracks `cost.total_api_duration_ms` deltas between statusline invocations instead of checking token accumulation. Should trigger exercises ONLY during actual API calls, not on every statusline refresh.

    Steps:
    1. Start a Claude Code session with VibeRipped statusline configured
    2. Observe: exercise prompt should NOT appear immediately when Claude Code starts (pre-first-API state)
    3. Send a message to Claude Code (triggers API call)
    4. Observe: exercise prompt SHOULD appear in statusline during/after API processing
    5. Wait for Claude Code to finish responding
    6. Observe: exercise prompt should remain visible during cooldown but NOT trigger new exercises on routine statusline refreshes
    7. Send another message after cooldown expires
    8. Observe: new exercise prompt appears (proving delta detection works across multiple API calls)
    9. Verify no spurious exercise changes between API calls

    What to look for:
    - GOOD: Exercises only change when you interact with Claude Code (send messages)
    - BAD: Exercises changing/flickering on every statusline update (indicates false positives still present)
    - BAD: No exercises ever appearing (indicates detection is too strict or broken)
  </action>
  <verify>
    Live Claude Code session shows exercises only during/after API calls, not on idle statusline refreshes.
  </verify>
  <done>
    Detection accuracy confirmed in live session. No false positives on routine updates, exercises appear during actual API processing.
  </done>
</task>

</tasks>

<verification>
- `node --test test/statusline.test.js` passes all updated and new tests
- `node --test` passes all tests project-wide
- statusline.js loads config and passes to isProcessing
- Integration tests cover: delta detection, no-delta silence, session reset, v1.0 fallback
- Live testing confirms real-world detection accuracy
</verification>

<success_criteria>
- statusline.js correctly wires config into isProcessing call
- Integration tests pass with new cost-field-based JSON fixtures
- Fallback to v1.0 heuristic tested end-to-end
- Session reset behavior tested end-to-end
- Live testing confirms false positives eliminated in real Claude Code session
- All existing tests continue passing (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/14-detection-improvement/14-02-SUMMARY.md`
</output>
