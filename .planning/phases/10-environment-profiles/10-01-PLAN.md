---
phase: 10-environment-profiles
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/pool.js
  - engine.js
  - test/pool.test.js
  - test/engine.test.js
autonomous: true

must_haves:
  truths:
    - "assemblePool filters exercises by environment when environment parameter provided"
    - "Exercises tagged 'anywhere' appear in all environments"
    - "Empty environment filter result falls back to equipment-only pool"
    - "Engine passes config.environment to assemblePool at runtime"
    - "Rotation index resets when filtered pool size changes vs stored pool hash"
  artifacts:
    - path: "lib/pool.js"
      provides: "assemblePool with environment filtering"
      exports: ["assemblePool"]
      contains: "environments"
    - path: "engine.js"
      provides: "Runtime environment-aware pool assembly"
      contains: "environment"
    - path: "test/pool.test.js"
      provides: "Environment filtering unit tests"
      contains: "environment"
    - path: "test/engine.test.js"
      provides: "Engine environment integration tests"
      contains: "environment"
  key_links:
    - from: "engine.js"
      to: "lib/pool.js"
      via: "assemblePool(config, environment)"
      pattern: "assemblePool\\(config,.*environment"
    - from: "engine.js"
      to: "lib/config.js"
      via: "config.environment"
      pattern: "config\\.environment"
---

<objective>
TDD implementation of environment-based exercise pool filtering.

Purpose: Enable assemblePool() to filter exercises by environment context (office, home, coworking) with "anywhere" wildcard support, and wire engine.js to pass config.environment at runtime.

Output: Environment-aware pool filtering with full test coverage.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-environment-profiles/10-RESEARCH.md
@lib/pool.js
@engine.js
@lib/config.js
@test/pool.test.js
@test/engine.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD environment filtering in assemblePool</name>
  <files>lib/pool.js, test/pool.test.js</files>
  <action>
RED phase - Add tests to test/pool.test.js in a new "environment filtering" describe block:

1. "includes exercises tagged 'anywhere' regardless of active environment" - assemblePool({equipment:{}}, 'office') should include exercises with environments:["anywhere"]
2. "includes exercises matching active environment" - assemblePool({equipment:{}}, 'office') should include exercises with environments:["office"]
3. "excludes exercises not matching active environment" - assemblePool({equipment:{}}, 'office') should NOT include exercises with environments:["home"]
4. "defaults missing environments array to anywhere" - exercises without environments field should be included in any environment
5. "falls back to equipment-only pool when environment filter empties result" - assemblePool with environment that matches nothing should return equipment-filtered pool (not empty), logging to stderr
6. "defaults environment parameter to anywhere when omitted" - assemblePool(config) with no second arg should behave identically to assemblePool(config, 'anywhere')
7. "chains equipment then environment filters" - with kettlebell enabled and environment 'office', only kettlebell exercises tagged 'office' or 'anywhere' should appear (plus bodyweight matching environment)

Run tests: `node --test test/pool.test.js` -- all new tests MUST fail (RED).

GREEN phase - Modify assemblePool in lib/pool.js:
- Add second parameter: `function assemblePool(equipmentConfig, environment = 'anywhere')`
- After existing equipment filtering, add environment filter step:
  ```
  const envFiltered = pool.filter(exercise => {
    const exerciseEnvs = exercise.environments || ['anywhere'];
    return exerciseEnvs.includes('anywhere') || exerciseEnvs.includes(environment);
  });
  ```
- Add fail-safe: if envFiltered.length === 0, log to stderr and return equipment-filtered pool
- Return envFiltered instead of pool

Run tests: `node --test test/pool.test.js` -- all tests MUST pass (GREEN).

IMPORTANT: Do NOT modify the assemblePool export signature or FULL_EXERCISE_DATABASE. The second parameter has a default value so all existing callers work unchanged.
  </action>
  <verify>`node --test test/pool.test.js` -- all tests pass including new environment filtering tests</verify>
  <done>assemblePool accepts optional environment parameter, filters by environment with "anywhere" wildcard, falls back on empty result, all existing tests still pass</done>
</task>

<task type="auto">
  <name>Task 2: TDD engine runtime environment filtering</name>
  <files>engine.js, test/engine.test.js</files>
  <action>
RED phase - Add tests to test/engine.test.js in a new "environment filtering" describe block:

1. "passes config environment to assemblePool in config-driven mode" - Create a config with environment:"office" and a pool.json with exercises tagged for different environments. Trigger in config-driven mode. Verify the returned exercise comes from the environment-filtered pool (office or anywhere), not from excluded environments.
2. "defaults to anywhere when config has no environment field" - Create a config without environment field (simulating v1.0 config). Trigger should work with all "anywhere" exercises.
3. "resets index when filtered pool is smaller than current index" - Set state.currentIndex to 8, trigger with environment that filters pool to 5 exercises. Should not crash, should return valid exercise.

Use isolated temp HOME directories following existing engine test patterns. Write pool.json with mixed-environment exercises for test isolation:
- 3 exercises tagged ["anywhere"]
- 2 exercises tagged ["office"]
- 2 exercises tagged ["home"]

Run tests: `node --test test/engine.test.js` -- new tests MUST fail (RED).

GREEN phase - Modify engine.js trigger():

In the config-driven mode block (where `pool === null`), after loading config:
1. Extract environment: `const environment = config.environment || 'anywhere';`
2. Change `assemblePool(config)` to `assemblePool(config, environment)`

That's it. The existing bounds check (`if (state.currentIndex >= actualPool.length)`) already handles index reset. The existing pool hash change detection handles pool size changes.

CRITICAL: Do NOT change the pool.json regeneration logic. Environment is a RUNTIME filter -- pool.json stores the full equipment-filtered pool, and environment filtering happens in trigger() each time. This means pool.json does NOT change when environment changes, only the actualPool used for rotation changes.

Run tests: `node --test test/engine.test.js` -- all tests MUST pass (GREEN).

Run full test suite: `node --test` to confirm no regressions.
  </action>
  <verify>`node --test` -- entire test suite passes with zero failures</verify>
  <done>engine.js reads config.environment and passes it to assemblePool for runtime filtering. Exercises returned match active environment or "anywhere". Index bounds handled. No regressions.</done>
</task>

</tasks>

<verification>
1. `node --test test/pool.test.js` -- all pool tests pass including 7+ new environment tests
2. `node --test test/engine.test.js` -- all engine tests pass including 3+ new environment tests
3. `node --test` -- full suite passes with zero failures
4. Manual: Create temp config with `environment: "office"`, verify assemblePool returns only office+anywhere exercises
</verification>

<success_criteria>
- assemblePool(config, 'office') returns only exercises tagged 'office' or 'anywhere'
- assemblePool(config) (no second arg) returns all 'anywhere' exercises (backward compatible)
- Empty filter result falls back to equipment-only pool with stderr warning
- engine.js trigger() reads config.environment and passes to assemblePool
- Full test suite passes with 10+ new environment-related tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-environment-profiles/10-01-SUMMARY.md`
</output>
