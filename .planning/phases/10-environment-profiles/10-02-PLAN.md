---
phase: 10-environment-profiles
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - bin/vibripped.js
  - lib/cli/commands/config.js
  - lib/cli/commands/pool.js
  - test/cli/config.test.js
  - test/cli/pool.test.js
autonomous: true

must_haves:
  truths:
    - "User can set environment via 'vibripped config set environment office'"
    - "User can read environment via 'vibripped config get environment'"
    - "User can tag exercises with environments via 'pool add' --environments flag"
    - "Pool list shows environment tags for each exercise"
    - "Config show mode displays current environment"
  artifacts:
    - path: "bin/vibripped.js"
      provides: "config set/get subcommands"
      contains: "config.*set"
    - path: "lib/cli/commands/config.js"
      provides: "config set/get handlers with environment support"
      contains: "environment"
    - path: "lib/cli/commands/pool.js"
      provides: "pool add with --environments flag, pool list with env display"
      contains: "environments"
    - path: "test/cli/config.test.js"
      provides: "CLI config set/get integration tests"
      contains: "environment"
  key_links:
    - from: "bin/vibripped.js"
      to: "lib/cli/commands/config.js"
      via: "config set/get command routing"
      pattern: "config.*command.*set"
    - from: "lib/cli/commands/config.js"
      to: "lib/config.js"
      via: "loadConfig/saveConfig for environment persistence"
      pattern: "saveConfig"
    - from: "lib/cli/commands/pool.js"
      to: "pool.json"
      via: "environments field in new exercises"
      pattern: "environments"
---

<objective>
CLI commands for environment profile management and exercise environment tagging.

Purpose: Give users the ability to set their active environment, query it, and tag exercises with environment contexts -- completing the environment profiles feature.

Output: Working CLI commands (`config set/get`, `pool add --environments`) with integration tests.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-environment-profiles/10-RESEARCH.md
@.planning/phases/10-environment-profiles/10-01-SUMMARY.md
@bin/vibripped.js
@lib/cli/commands/config.js
@lib/cli/commands/pool.js
@lib/cli/output.js
@lib/cli/validation.js
@lib/config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config set/get subcommands and update config show</name>
  <files>bin/vibripped.js, lib/cli/commands/config.js, test/cli/config.test.js</files>
  <action>
This task involves a COORDINATED BREAKING CHANGE between two files. Both sides of the change must be made together.

CURRENT MODULE STRUCTURE (lib/cli/commands/config.js):
```javascript
// config.js currently exports a SINGLE FUNCTION as the default export:
function configHandler(options) { ... }
module.exports = configHandler;
```

CURRENT CALLER (bin/vibripped.js, lines 33-36):
```javascript
.action((options) => {
    const configHandler = require(path.join(__dirname, '../lib/cli/commands/config.js'));
    configHandler(options);  // <-- calls the default export directly as a function
});
```

AFTER REFACTOR, config.js will export an OBJECT with named methods:
```javascript
module.exports = { show, set, get };
```

This means bin/vibripped.js MUST change its call from `configHandler(options)` to `configHandler.show(options)`. Both files must be updated in this task.

---

**lib/cli/commands/config.js changes:**

Refactor the single `configHandler(options)` function into three named functions:

- `show(options)`: Rename the existing configHandler function body. Contains all existing logic: check for equipment flags, if none show config, if flags present update equipment. ADD environment display to show mode output, after the equipment lines: `info('  Environment:  ' + config.environment);`
- `set(key, value)`: NEW function. Handle `key === 'environment'` -- validate value is non-empty string, load config via `loadConfig(getConfigPath())`, update `config.environment = value`, save via `saveConfig(getConfigPath(), config)`. Print success: `success('Environment set to: ' + value)`. For unknown keys, print error: `error('Unknown config key: ' + key + '. Settable keys: environment')` and `process.exitCode = 1`.
- `get(key)`: NEW function. Handle `key === 'environment'` -- load config via `loadConfig(getConfigPath())`, print `info(config.environment)`. For unknown keys, print error and `process.exitCode = 1`.

Change the module export from:
```javascript
module.exports = configHandler;
```
to:
```javascript
module.exports = { show, set, get };
```

---

**bin/vibripped.js changes:**

Replace the flat `config` command (lines 22-36) with a Commander command group supporting three modes:

1. `vibripped config` (no args) -- show current config (existing behavior, now via `.show()`)
2. `vibripped config set <key> <value>` -- set a config value
3. `vibripped config get <key>` -- get a config value

Implementation:
```javascript
const configCmd = program.command('config')
  .description('Show or manage configuration')
  .action((options) => {
    // No subcommand = show mode (existing behavior)
    const configHandler = require(path.join(__dirname, '../lib/cli/commands/config.js'));
    configHandler.show(options);  // <-- CHANGED from configHandler(options)
  });

// Keep existing equipment flags on the base config command for backward compat
configCmd
  .option('--kettlebell', 'Enable kettlebell exercises')
  .option('--no-kettlebell', 'Disable kettlebell exercises')
  .option('--dumbbells', 'Enable dumbbell exercises')
  .option('--no-dumbbells', 'Disable dumbbell exercises')
  .option('--pull-up-bar', 'Enable pull-up bar exercises')
  .option('--no-pull-up-bar', 'Disable pull-up bar exercises')
  .option('--parallettes', 'Enable parallettes exercises')
  .option('--no-parallettes', 'Disable parallettes exercises');

configCmd
  .command('set <key> <value>')
  .description('Set configuration value (e.g., environment)')
  .action((key, value) => {
    const configHandler = require(path.join(__dirname, '../lib/cli/commands/config.js'));
    configHandler.set(key, value);
  });

configCmd
  .command('get <key>')
  .description('Get configuration value')
  .action((key) => {
    const configHandler = require(path.join(__dirname, '../lib/cli/commands/config.js'));
    configHandler.get(key);
  });
```

CRITICAL: The `.action()` on the base config command now calls `configHandler.show(options)` instead of `configHandler(options)`. This is the breaking change -- if you update config.js exports but forget to update bin/vibripped.js, `configHandler(options)` will throw "configHandler is not a function" because the export is now an object.

IMPORTANT: The existing `vibripped config --kettlebell` equipment flag behavior MUST continue working. The `show(options)` function checks if any equipment flags are set to determine mode (show vs set equipment), exactly as the current configHandler does.

---

**test/cli/config.test.js changes:**

Create or extend test file with integration tests using child_process.execSync spawning `bin/vibripped.js`:

1. "config set environment office" -- sets environment in configuration.json, exits 0
2. "config get environment" -- reads and prints current environment, exits 0
3. "config set environment office then get" -- roundtrip: set then get returns "office"
4. "config set unknown-key fails" -- prints error, exits 1
5. "config get unknown-key fails" -- prints error, exits 1
6. "config show displays environment" -- `vibripped config` output includes "Environment:" line
7. "config --kettlebell still works" -- backward compat: equipment flags still update config

Use isolated temp HOME dirs following existing CLI test patterns (set HOME env var in execSync).
  </action>
  <verify>`node --test test/cli/config.test.js` passes all tests. Manual: `node bin/vibripped.js config set environment office && node bin/vibripped.js config get environment` prints "office".</verify>
  <done>Users can run `vibripped config set environment office` and `vibripped config get environment`. Config show mode displays current environment. Equipment flag backward compat preserved. 7+ integration tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add --environments flag to pool add and show envs in pool list</name>
  <files>lib/cli/commands/pool.js, bin/vibripped.js, test/cli/pool.test.js</files>
  <action>
**bin/vibripped.js changes:**

Add `--environments` option to the pool add command:
```javascript
poolCmd
  .command('add <name> <reps>')
  .description('Add exercise to pool')
  .option('--type <type>', 'Exercise type: reps or timed', 'reps')
  .option('--duration <seconds>', 'Duration in seconds (for timed exercises)')
  .option('--environments <envs>', 'Comma-separated environments (e.g., "home,office")')
  .action((name, reps, options) => {
    const poolHandler = require(path.join(__dirname, '../lib/cli/commands/pool.js'));
    poolHandler.add(name, reps, options);
  });
```

**lib/cli/commands/pool.js changes:**

In the `add` function:
1. Parse `options.environments` if provided: split on comma, trim whitespace, filter empty strings
2. Validate each environment string is non-empty
3. If not provided, default to `["anywhere"]`
4. Add `environments` field to the newExercise object

```javascript
// Parse environments option
let environments = ['anywhere'];  // default
if (options.environments) {
  const parsed = options.environments.split(',').map(e => e.trim()).filter(e => e.length > 0);
  if (parsed.length === 0) {
    error('Invalid environments (provide comma-separated list)', 'vibripped pool add "Exercise" 15 --environments "home,office"');
    process.exit(1);
  }
  environments = parsed;
}

// Add to newExercise object
newExercise.environments = environments;
```

In the `list` function:
Update the display to show environment tags after the equipment tag:
```javascript
// Environment display
const envs = exercise.environments
  ? exercise.environments.join(', ')
  : 'anywhere';

info(`  ${i + 1}. ${display} [${equipment}] (${envs})`);
```

**test/cli/pool.test.js changes:**

Add integration tests:

1. "pool add with --environments tags exercise correctly" -- add exercise with `--environments "home,office"`, then load pool.json and verify environments field is `["home", "office"]`
2. "pool add without --environments defaults to anywhere" -- add exercise, verify environments is `["anywhere"]`
3. "pool list shows environment tags" -- verify list output contains environment info in parentheses
4. "pool add with empty --environments fails" -- `--environments ""` should error

Use isolated temp HOME dirs.
  </action>
  <verify>`node --test test/cli/pool.test.js` passes all tests. Full suite: `node --test` passes with zero failures.</verify>
  <done>Users can tag exercises with environments via `pool add "Desk stretches" 30 --environments "office,coworking"`. Pool list shows environment tags. Default is "anywhere". Full test suite passes.</done>
</task>

</tasks>

<verification>
1. `node --test` -- full test suite passes
2. End-to-end workflow:
   ```
   vibripped config set environment office
   vibripped config get environment  # prints "office"
   vibripped pool add "Desk stretches" 30 --environments "office,anywhere"
   vibripped pool list  # shows environment tags
   vibripped config  # shows Environment: office
   ```
3. Backward compat: `vibripped config --kettlebell` still works
4. Statusline: exercises from non-matching environments are excluded from rotation
</verification>

<success_criteria>
- `vibripped config set environment office` persists environment to configuration.json
- `vibripped config get environment` prints current environment
- `vibripped config` show mode displays environment alongside equipment
- `vibripped pool add "X" 15 --environments "home,office"` tags exercise with environments
- `vibripped pool list` shows environment tags for each exercise
- Equipment flag backward compatibility preserved
- Full test suite passes with 10+ new integration tests
</success_criteria>

<output>
After completion, create `.planning/phases/10-environment-profiles/10-02-SUMMARY.md`
</output>
