---
phase: 11-category-aware-rotation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/rotation.js
  - test/rotation.test.js
autonomous: true

must_haves:
  truths:
    - "getNextExercise filters out exercises from recently-used categories"
    - "Uncategorized exercises (category=null) always pass category filter"
    - "Single-category pool falls back to full pool instead of crashing"
    - "Ring buffer bounds recentCategories to configurable max size (default 2)"
    - "Same pool state always produces same next exercise (determinism preserved)"
  artifacts:
    - path: "lib/rotation.js"
      provides: "Category-aware getNextExercise with filter, fallback, and ring buffer"
      exports: ["getNextExercise"]
    - path: "test/rotation.test.js"
      provides: "Unit tests for category-aware rotation algorithm"
      min_lines: 80
  key_links:
    - from: "lib/rotation.js"
      to: "state.recentCategories"
      via: "reads recentCategories from state, pushes new category after selection"
      pattern: "state\\.recentCategories"
    - from: "lib/rotation.js"
      to: "exercise.category"
      via: "filters pool by exercise.category against recentCategories"
      pattern: "exercise\\.category"
---

<objective>
Implement category-aware exercise selection in rotation.js using TDD.

Purpose: Prevent consecutive same-muscle-group exercises by filtering the pool based on recently-used categories (push/pull/legs/core), with deterministic fallback for edge cases.

Output: Modified `lib/rotation.js` with category-aware `getNextExercise`, new `test/rotation.test.js` with comprehensive unit tests.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-category-aware-rotation/11-RESEARCH.md
@lib/rotation.js
@lib/pool.js
@lib/state.js
@test/engine.test.js
</context>

<feature>
  <name>Category-Aware Exercise Rotation</name>
  <files>lib/rotation.js, test/rotation.test.js</files>
  <behavior>
    getNextExercise(state, pool) now filters the pool to exclude exercises whose category
    appears in state.recentCategories before selecting the next exercise deterministically.

    The function signature and return value remain unchanged for backward compatibility.
    When all exercises in pool lack categories (v1.0 pools), behavior is identical to current.

    Cases:
    - Pool [push, pull, legs, core], recentCategories=["push"] -> selects from [pull, legs, core]
    - Pool [push, pull, legs, core], recentCategories=["push","pull"] -> selects from [legs, core]
    - Pool [push, push, push], recentCategories=["push"] -> fallback to full pool (single category)
    - Pool [push, null, pull], recentCategories=["push"] -> selects from [null, pull] (null always passes)
    - Pool [{no category}, {no category}], recentCategories=[] -> selects sequentially (v1.0 compat)
    - After selection, exercise.category pushed to recentCategories (ring buffer, max 2)
    - recentCategories never exceeds configured max size (shift oldest when full)
    - Same state + same pool always produces same exercise (deterministic)
  </behavior>
  <implementation>
    Modify getNextExercise in lib/rotation.js:

    1. Read state.recentCategories (default to [] if missing for v1.0 backward compat)
    2. Filter pool: include exercise if exercise.category is null/undefined OR not in recentCategories
    3. If filtered pool is empty, fall back to full pool (log warning to stderr)
    4. Select exercise: candidatePool[state.currentIndex % candidatePool.length]
    5. Advance state.currentIndex: (state.currentIndex + 1) % pool.length (full pool space)
    6. If selected exercise.category is not null/undefined, push to state.recentCategories
    7. If state.recentCategories.length > MAX_RECENT (2), shift oldest entry
    8. Return { exercise, previousIndex } (unchanged signature)

    Export MAX_RECENT_CATEGORIES constant (value: 2) for testability.

    Key design decisions:
    - currentIndex advances in FULL pool space (not filtered pool) to maintain deterministic traversal
    - Null/undefined categories always pass filter AND are never tracked in recentCategories
    - Fallback to full pool when filter empties it (single-category pool edge case)
    - MAX_RECENT_CATEGORIES = 2 as constant (per research recommendation: start with constant, promote to config later if needed)
  </implementation>
</feature>

<verification>
Run: `node --test test/rotation.test.js`
All tests pass including:
- Sequential selection with category filtering
- Ring buffer bounds (never exceeds MAX_RECENT_CATEGORIES)
- Null/undefined category passthrough
- Single-category pool fallback
- v1.0 backward compatibility (pool without categories)
- Determinism (same state produces same result)

Run: `node --test test/*.test.js`
All existing 194 tests still pass (zero regressions).
</verification>

<success_criteria>
- getNextExercise filters pool by recentCategories before selection
- Uncategorized exercises always pass filter
- Single-category pool triggers fallback, not crash
- recentCategories bounded to MAX_RECENT_CATEGORIES (2)
- Deterministic: same state + pool = same result
- All new unit tests pass
- All existing 194 tests pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/11-category-aware-rotation/11-01-SUMMARY.md`
</output>
