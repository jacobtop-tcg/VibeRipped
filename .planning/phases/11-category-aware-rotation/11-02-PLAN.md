---
phase: 11-category-aware-rotation
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - engine.js
  - test/engine.test.js
autonomous: true

must_haves:
  truths:
    - "Engine trigger persists recentCategories to state.json after each exercise selection"
    - "Consecutive triggers never produce same-category exercises (multi-category pool)"
    - "State.json recentCategories survives restart and is loaded on next trigger"
    - "v1.0 legacy mode (explicit pool without categories) still works unchanged"
    - "Edge case: pool with only one category triggers fallback, returns exercise without crash"
  artifacts:
    - path: "engine.js"
      provides: "Category-aware trigger flow with recentCategories persistence"
      exports: ["trigger", "formatPrompt"]
    - path: "test/engine.test.js"
      provides: "Integration tests for category-aware rotation through engine"
      min_lines: 950
  key_links:
    - from: "engine.js"
      to: "lib/rotation.js:getNextExercise"
      via: "passes state with recentCategories to category-aware getNextExercise"
      pattern: "getNextExercise\\(state.*pool\\)"
    - from: "engine.js"
      to: "state.json"
      via: "writeFileSync persists state including recentCategories"
      pattern: "writeFileSync.*JSON\\.stringify\\(state"
---

<objective>
Wire category-aware rotation into engine.js trigger flow and add integration tests.

Purpose: Ensure recentCategories is properly initialized, passed to rotation, and persisted to state.json so category avoidance works across triggers and survives restarts.

Output: Updated `engine.js` with recentCategories flow, updated `test/engine.test.js` with category rotation integration tests.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-category-aware-rotation/11-RESEARCH.md
@.planning/phases/11-category-aware-rotation/11-01-SUMMARY.md
@engine.js
@lib/rotation.js
@lib/state.js
@test/engine.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Engine recentCategories wiring</name>
  <files>engine.js</files>
  <action>
    Wire recentCategories through the engine trigger flow. The changes needed in engine.js are minimal since getNextExercise (Plan 01) already mutates state.recentCategories directly:

    1. Ensure state.recentCategories is initialized when loading/creating state:
       - createDefaultState already includes recentCategories: [] (Phase 8)
       - Verify inline state loading in trigger() initializes recentCategories: [] if missing (v1.0 state files may lack it)
       - After state is loaded/created, add: `state.recentCategories = state.recentCategories || [];`

    2. The call to getNextExercise(state, actualPool) already passes state by reference, and Plan 01's updated getNextExercise mutates state.recentCategories in place. No change needed to the getNextExercise call itself.

    3. State persistence (writeFileSync) already serializes full state object including recentCategories. No change needed to save logic.

    4. Verify the cooldown path (lines ~210-226) does NOT modify recentCategories (it should not - cooldown means no new exercise was selected).

    This is light wiring - the heavy lifting is in Plan 01's rotation.js. The key addition is the recentCategories initialization guard for backward compatibility with v1.0 state files.
  </action>
  <verify>
    Run: `node -e "const {trigger} = require('./engine'); const r = trigger([{name:'Push',reps:10,category:'push'},{name:'Pull',reps:10,category:'pull'},{name:'Squat',reps:10,category:'legs'}], {bypassCooldown:true, statePath:'/tmp/vr-cat-test.json'}); console.log(r.exercise.name, JSON.stringify(require('fs').readFileSync('/tmp/vr-cat-test.json','utf8')))"`
    - Output includes exercise name and state.json content with recentCategories array
  </verify>
  <done>
    Engine trigger initializes recentCategories on state load, getNextExercise mutates it, state persistence writes it to disk. v1.0 state files without recentCategories get initialized to [].
  </done>
</task>

<task type="auto">
  <name>Task 2: Category rotation integration tests</name>
  <files>test/engine.test.js</files>
  <action>
    Add a new describe block "Rotation Engine - Category-Aware Rotation" to test/engine.test.js with integration tests that exercise the full trigger -> rotation -> state persistence flow:

    Test cases (each uses isolated HOME dir per existing test pattern, bypassCooldown: true):

    1. "consecutive triggers avoid same category" - Create pool with 4 categories (push, pull, legs, core). Trigger twice. Verify second exercise has different category than first.

    2. "recentCategories persisted to state.json" - Trigger once with categorized pool. Read state.json. Verify recentCategories array contains the selected exercise's category.

    3. "recentCategories loaded from state across triggers" - Trigger twice sequentially. Read state.json after each. Verify recentCategories grows from 1 to 2 entries, and second entry matches second exercise's category.

    4. "recentCategories bounded to max size" - Trigger 5+ times with multi-category pool. Read state.json. Verify recentCategories.length never exceeds 2 (MAX_RECENT_CATEGORIES).

    5. "single-category pool falls back gracefully" - Create pool with only "push" exercises. Trigger twice. Verify no crash, second trigger still returns an exercise (fallback to full pool).

    6. "v1.0 pool without categories works unchanged" - Create pool with no category fields (v1.0 format: just name+reps). Trigger multiple times. Verify sequential rotation works identically to pre-Phase-11 behavior, no crashes.

    7. "null category exercises always appear in rotation" - Create pool with mix of categorized and category:null exercises. Trigger multiple times. Verify null-category exercise appears (never filtered out).

    Follow existing test patterns in engine.test.js:
    - Use os.tmpdir() for isolated HOME
    - Set process.env.HOME / XDG_CONFIG_HOME for isolation
    - Use trigger(pool, { bypassCooldown: true, statePath }) for direct pool mode
    - Clean up temp dirs in afterEach
  </action>
  <verify>
    Run: `node --test test/engine.test.js`
    All tests pass including new category rotation tests.

    Run: `node --test test/*.test.js`
    Full suite passes (194 existing + new tests, zero regressions).
  </verify>
  <done>
    7+ integration tests verify category-aware rotation works end-to-end through engine trigger flow: category avoidance, state persistence, ring buffer bounds, single-category fallback, v1.0 backward compatibility, null category handling.
  </done>
</task>

</tasks>

<verification>
Run full test suite: `node --test test/*.test.js`
All tests pass including:
- All 194 existing tests (zero regressions)
- New category rotation integration tests (7+ tests)

Manual verification:
```bash
# Trigger 4 times with categorized pool, verify no consecutive same-category
node -e "
const {trigger} = require('./engine');
const pool = [
  {name:'Pushups',reps:15,category:'push'},
  {name:'Squats',reps:20,category:'legs'},
  {name:'Rows',reps:12,category:'pull'},
  {name:'Plank',reps:30,category:'core'}
];
const sp = '/tmp/vr-cat-verify.json';
const results = [];
for (let i = 0; i < 4; i++) {
  const r = trigger(pool, {bypassCooldown:true, statePath:sp});
  results.push(r.exercise.category);
}
console.log('Categories:', results);
const adj = results.slice(1).every((c,i) => c !== results[i]);
console.log('No consecutive duplicates:', adj);
"
```
Expected: "No consecutive duplicates: true"
</verification>

<success_criteria>
- Engine properly initializes recentCategories for v1.0 state backward compatibility
- Consecutive triggers produce different categories (multi-category pool)
- recentCategories persisted in state.json and loaded across triggers
- recentCategories length bounded to 2 across many triggers
- Single-category pool triggers fallback, returns exercise
- v1.0 pools without categories work unchanged
- All tests pass (existing 194 + new integration tests)
</success_criteria>

<output>
After completion, create `.planning/phases/11-category-aware-rotation/11-02-SUMMARY.md`
</output>
