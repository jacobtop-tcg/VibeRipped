---
phase: 08-data-model-extensions
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/pool.js
  - lib/config.js
  - lib/state.js
  - test/pool.test.js
  - test/config.test.js
  - test/state.test.js
autonomous: true

must_haves:
  truths:
    - "v1.0 exercise objects pass validation unchanged (backward compatible)"
    - "v1.1 exercise objects with category, type, environments pass validation"
    - "Invalid category/type/environments values are rejected by validation"
    - "Configuration with optional environment field passes validation"
    - "State with optional recentCategories array passes validation"
    - "Missing optional fields default gracefully during normalization"
  artifacts:
    - path: "lib/pool.js"
      provides: "Exercise validation with optional category/type/environments fields"
      contains: "validateExercise"
    - path: "lib/config.js"
      provides: "Config validation and normalization with optional environment field"
      contains: "environment"
    - path: "lib/state.js"
      provides: "State creation and validation with optional recentCategories"
      contains: "recentCategories"
    - path: "test/pool.test.js"
      provides: "Tests for v1.1 exercise schema validation"
      contains: "category"
    - path: "test/config.test.js"
      provides: "Tests for v1.1 config schema validation"
      contains: "environment"
    - path: "test/state.test.js"
      provides: "Tests for v1.1 state schema validation"
      contains: "recentCategories"
  key_links:
    - from: "lib/pool.js"
      to: "lib/config.js"
      via: "EQUIPMENT_KEYS shared constant"
      pattern: "EQUIPMENT_KEYS"
    - from: "lib/state.js"
      to: "lib/pool.js"
      via: "computePoolHash for state creation"
      pattern: "computePoolHash"
---

<objective>
Extend pool.js, config.js, and state.js schemas with optional v1.1 fields (category, type, environments, environment, recentCategories) while maintaining full backward compatibility with v1.0 data.

Purpose: Lay the schema foundation for timed exercises (Phase 9), environment profiles (Phase 10), and category-aware rotation (Phase 11) without breaking any existing functionality.
Output: Extended validation functions, updated normalization/defaults, comprehensive test coverage for both v1.0 and v1.1 schemas.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-data-model-extensions/08-RESEARCH.md
@lib/pool.js
@lib/config.js
@lib/state.js
@test/pool.test.js
@test/config.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend pool.js with exercise-level v1.1 field validation and add category tags to FULL_EXERCISE_DATABASE</name>
  <files>lib/pool.js, test/pool.test.js</files>
  <action>
TDD: Write tests first, then implement.

**Tests to add in test/pool.test.js** (new describe block "v1.1 exercise schema"):
- v1.0 exercise `{ name: "Pushups", reps: 15 }` still passes validateExercise
- v1.0 exercise with equipment `{ name: "Pull-ups", reps: 8, equipment: ["pullUpBar"] }` still passes
- v1.1 exercise with all fields passes: `{ name: "Pushups", reps: 15, category: "push", type: "reps", environments: ["anywhere"] }`
- v1.1 timed exercise passes: `{ name: "Plank", reps: 30, category: "core", type: "timed", environments: ["anywhere", "office"] }`
- Invalid category rejected: `{ name: "X", reps: 10, category: "invalid" }` returns false
- Valid categories accepted: "push", "pull", "legs", "core" each pass
- Invalid type rejected: `{ name: "X", reps: 10, type: "invalid" }` returns false
- Valid types accepted: "reps", "timed" each pass
- Invalid environments rejected: `{ name: "X", reps: 10, environments: "not-array" }` returns false
- Empty string in environments rejected: `{ name: "X", reps: 10, environments: [""] }` returns false
- Valid environments accepted: `["home", "office", "anywhere"]` passes
- null category is valid (uncategorized exercise): `{ name: "X", reps: 10, category: null }` passes

**Implementation in lib/pool.js:**

1. Create and export `validateExercise(exercise)` function:
   - Required: name (non-empty string), reps (positive integer)
   - Optional: equipment (array of strings), category (one of ["push", "pull", "legs", "core"] or null), type (one of ["reps", "timed"]), environments (array of non-empty strings)
   - If optional field present and not undefined, validate its type and value
   - category=null is explicitly valid (means "uncategorized")

2. Export VALID_CATEGORIES = ["push", "pull", "legs", "core"] and VALID_TYPES = ["reps", "timed"] as named constants for reuse by other modules.

3. Add category and type tags to each exercise in FULL_EXERCISE_DATABASE. Tag mapping:
   - Push: Pushups, Desk pushups, Overhead press, Parallette pushups, Tuck planche
   - Pull: Dumbbell rows, Pull-ups, Chin-ups, Dumbbell curls, Lateral raises, Dead hangs
   - Legs: Bodyweight squats, Lunges, Calf raises, High knees, Goblet squats, Kettlebell deadlifts, Glute bridges
   - Core: Wall sit, Plank, Tricep dips, Hanging knee raises, L-sit, Parallette dips, Turkish get-up, Kettlebell swings

   Type mapping:
   - timed: Wall sit, Plank, Dead hangs, L-sit
   - reps: everything else

   All FULL_EXERCISE_DATABASE exercises get `environments: ["anywhere"]` (default).

4. Do NOT modify DEFAULT_POOL (it stays v1.0 compatible with just name/reps).

5. Update `assemblePool` to strip equipment-only fields from output (keep existing behavior) but preserve new v1.1 fields (category, type, environments) if present on source exercises.

**Important:** The `reps` field for timed exercises (Wall sit, Plank, etc.) keeps its existing value - `reps` holds seconds for timed exercises. The `type` field is what tells the display layer how to format it (Phase 9 concern). No display changes in this phase.
  </action>
  <verify>Run `node --test test/pool.test.js` - all existing tests pass, all new v1.1 schema tests pass.</verify>
  <done>validateExercise function exported and validates both v1.0 and v1.1 exercise shapes. FULL_EXERCISE_DATABASE exercises have category, type, and environments fields. VALID_CATEGORIES and VALID_TYPES constants exported.</done>
</task>

<task type="auto">
  <name>Task 2: Extend config.js and state.js with v1.1 optional fields, normalization, and defaults</name>
  <files>lib/config.js, lib/state.js, test/config.test.js, test/state.test.js</files>
  <action>
TDD: Write tests first, then implement.

**Tests to add in test/config.test.js** (new describe block "v1.1 config schema"):
- v1.0 config without environment field passes validateConfig
- v1.1 config with `environment: "office"` passes validateConfig
- v1.1 config with `environment: "anywhere"` passes validateConfig
- Non-string environment rejected: `environment: 123` returns false
- v1.1 config with `schemaVersion: "1.1"` passes validateConfig
- Non-string schemaVersion rejected: `schemaVersion: 1.1` returns false
- loadConfig normalizes missing environment to "anywhere" (write config without environment field, load it, check environment === "anywhere")
- loadConfig normalizes missing schemaVersion to "1.0" (write config without schemaVersion, load it, check schemaVersion === "1.0")
- loadConfig preserves explicit environment value (write config with environment: "office", load it, check environment === "office")
- DEFAULT_CONFIG includes environment and schemaVersion fields

**Tests to add in test/state.test.js** (new describe block "v1.1 state schema"):
- v1.0 state without recentCategories passes validateState
- v1.1 state with `recentCategories: ["push", "pull"]` passes validateState
- Non-array recentCategories rejected: `recentCategories: "push"` returns false
- Non-string entries in recentCategories rejected: `recentCategories: [123]` returns false
- createDefaultState includes empty recentCategories array
- v1.0 state with `schemaVersion: "1.0"` passes validateState
- Non-string schemaVersion rejected in state: `schemaVersion: 1.1` returns false

**Implementation in lib/config.js:**

1. Update DEFAULT_CONFIG to include:
   ```
   environment: "anywhere",
   schemaVersion: "1.0"
   ```

2. Extend `validateConfig()`:
   - If `config.environment` present and not undefined: must be string
   - If `config.schemaVersion` present and not undefined: must be string

3. Extend `loadConfig()` normalization block to include:
   - `environment: config.environment || "anywhere"`
   - `schemaVersion: config.schemaVersion || "1.0"`

**Implementation in lib/state.js:**

1. Update `createDefaultState(pool)` to include:
   - `recentCategories: []`
   - `schemaVersion: "1.0"`

2. Extend `validateState()`:
   - If `state.recentCategories` present and not undefined: must be array of strings
   - If `state.schemaVersion` present and not undefined: must be string
   - Do NOT make these required - v1.0 state without them is still valid

**Important:** All new fields are OPTIONAL in validation. v1.0 data without these fields must continue to pass validation. Only validate type correctness IF the field is present.
  </action>
  <verify>Run `node --test test/config.test.js` and `node --test test/state.test.js` - all existing and new tests pass. Then run `node --test` to confirm no regressions across the full suite.</verify>
  <done>config.js validates and normalizes optional environment and schemaVersion fields. state.js validates optional recentCategories and schemaVersion fields, createDefaultState includes them. DEFAULT_CONFIG updated. All v1.0 data still passes validation. Full test suite green.</done>
</task>

</tasks>

<verification>
1. `node --test` - all tests pass (zero regressions from v1.0 tests)
2. `node -e "const p = require('./lib/pool'); console.log(typeof p.validateExercise)"` prints "function"
3. `node -e "const p = require('./lib/pool'); console.log(p.VALID_CATEGORIES)"` prints ["push","pull","legs","core"]
4. `node -e "const c = require('./lib/config'); console.log(c.DEFAULT_CONFIG.environment)"` prints "anywhere"
5. `node -e "const s = require('./lib/state'); const pool = [{name:'X',reps:10}]; console.log(s.createDefaultState(pool).recentCategories)"` prints []
6. `node engine.js` still produces valid exercise output (no crashes from schema extensions)
</verification>

<success_criteria>
- All v1.0 tests pass unchanged (zero regressions)
- New v1.1 validation tests pass for pool, config, and state modules
- validateExercise exported and correctly validates category/type/environments
- loadConfig normalizes missing v1.1 fields to safe defaults
- createDefaultState includes recentCategories and schemaVersion
- FULL_EXERCISE_DATABASE exercises tagged with category, type, environments
- engine.js continues to function (no import/export breaks)
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-model-extensions/08-01-SUMMARY.md`
</output>
