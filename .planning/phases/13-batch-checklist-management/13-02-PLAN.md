---
phase: 13-batch-checklist-management
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - lib/cli/commands/pool.js
  - bin/viberipped.js
  - test/cli/pool.test.js
autonomous: true

must_haves:
  truths:
    - "User can run `viberipped pool manage` to launch interactive checklist view"
    - "Checklist shows all pool exercises with toggle on/off for each"
    - "Checklist respects TTY detection (fails gracefully in non-interactive mode)"
    - "User cannot uncheck all exercises (at least one must remain)"
    - "Unchecked exercises are removed from pool on confirm"
    - "Escape key cancels without changes"
  artifacts:
    - path: "lib/cli/commands/pool.js"
      provides: "manage() async function with CheckboxPrompt integration, TTY guard, empty pool guard"
      exports: ["manage"]
      contains: "async function manage"
    - path: "bin/viberipped.js"
      provides: "pool manage subcommand registered with Commander"
      contains: "pool.*manage"
    - path: "test/cli/pool.test.js"
      provides: "Integration tests for manage command: TTY guard rejection in non-interactive mode"
      contains: "manage"
  key_links:
    - from: "bin/viberipped.js"
      to: "lib/cli/commands/pool.js:manage"
      via: "Commander action handler calling poolHandler.manage()"
      pattern: "poolHandler\\.manage"
    - from: "lib/cli/commands/pool.js:manage"
      to: "lib/cli/ui/checkbox.js:CheckboxPrompt"
      via: "new CheckboxPrompt with pool items as choices"
      pattern: "new CheckboxPrompt"
    - from: "lib/cli/commands/pool.js:manage"
      to: "lib/cli/ui/tty.js:requireTTY"
      via: "TTY guard at function entry"
      pattern: "requireTTY\\('pool manage'\\)"
---

<objective>
Add interactive checklist management command so users can toggle exercises on/off in their pool without editing JSON.

Purpose: Non-technical users can remove exercises visually instead of running individual `pool remove` commands or editing pool.json by hand.
Output: New manage() function in pool.js, CLI registration, integration test for TTY guard.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-batch-checklist-management/13-RESEARCH.md
@.planning/phases/13-batch-checklist-management/13-01-SUMMARY.md
@lib/cli/commands/pool.js
@lib/cli/commands/setup.js
@lib/cli/ui/checkbox.js
@lib/cli/ui/tty.js
@bin/viberipped.js
@test/cli/pool.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Interactive manage command in pool.js + CLI registration</name>
  <files>lib/cli/commands/pool.js, bin/viberipped.js</files>
  <action>
**In lib/cli/commands/pool.js:**

Add imports at the top of the file for CheckboxPrompt and requireTTY:
```javascript
const { CheckboxPrompt } = require(path.join(__dirname, '../ui/checkbox'));
const { requireTTY } = require(path.join(__dirname, '../ui/tty'));
```

Create an `async function manage()` that:

1. **TTY guard** -- Call `requireTTY('pool manage')` as first line. If false, return immediately (requireTTY already sets exitCode=1 and prints error with non-interactive alternatives).

2. **Load pool** -- Call `loadPool()`. If null, call `process.exit(1)`.

3. **Build checkbox choices** -- Map pool to choices array with type-aware display labels:
   - For `type === 'timed'`: label = `"Name Ns"` where N is `exercise.duration ?? exercise.reps`
   - For reps (default): label = `"Name xN"`
   - Append equipment info: `[equipment]` or `[bodyweight]` if no equipment
   - Append environments: `(envs)` or `(anywhere)` if not specified
   - Each choice: `{ label, value: index, checked: true }` (all checked by default)
   - Match the display format used by the existing `list()` function for consistency

4. **Display instructions** -- Print navigation instructions (arrow keys, space to toggle, enter to save, escape to cancel).

5. **Show CheckboxPrompt** -- `new CheckboxPrompt('Toggle exercises (Space to toggle, Enter to confirm):', choices)`, await `.prompt()`.

6. **Handle escape (rejection)** -- Catch the error from prompt(), print "Pool management cancelled.", set `process.exitCode = 0`, return.

7. **Filter pool** -- Map selected indices back to pool entries: `selected.map(index => pool[index])`.

8. **Empty pool guard** -- If newPool.length === 0, print error "Cannot empty pool completely (at least one exercise required)", set `process.exitCode = 1`, return.

9. **No-change detection** -- If newPool.length === pool.length, print "No changes made to pool.", set `process.exitCode = 0`, return.

10. **Save** -- `savePool(newPool)`, `updateStateHash(computePoolHash(newPool))`.

11. **Success output** -- Print "Pool updated: N of M exercises kept", "Removed X exercise(s) from rotation.", "Rotation index reset to beginning."

12. Set `process.exitCode = 0`.

**Important:** Use `process.exitCode` (not `process.exit()`) in the async manage function to allow proper cleanup of readline/raw mode. The setup.js command follows this same pattern.

**Add manage to module.exports:**
```javascript
module.exports = { list, add, remove, manage };
```

**In bin/viberipped.js:**

Add a new subcommand to `poolCmd` after the existing `remove` command:
```javascript
poolCmd
  .command('manage')
  .description('Interactive checklist to toggle exercises on/off')
  .action(async () => {
    const poolHandler = require(path.join(__dirname, '../lib/cli/commands/pool.js'));
    await poolHandler.manage();
  });
```
  </action>
  <verify>
1. `node bin/viberipped.js pool manage --help` shows the manage command description
2. `echo "" | node bin/viberipped.js pool manage` should fail with TTY error (non-interactive context)
3. `node --test test/cli/pool.test.js` -- all existing tests still pass
  </verify>
  <done>
- manage() function exists in pool.js with TTY guard, CheckboxPrompt integration, empty pool guard, no-change detection
- pool manage subcommand registered in CLI
- manage exported from pool.js module
- Existing pool commands unaffected
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for manage command</name>
  <files>test/cli/pool.test.js</files>
  <action>
Add a new `describe('pool manage', ...)` block inside the existing `describe('pool command', ...)` in `test/cli/pool.test.js`.

**Tests to add:**

1. **manage command fails gracefully in non-TTY context** -- Run `pool manage` via runCLI (which spawns child process without TTY). Assert exit code 1 (requireTTY sets exitCode=1). Assert stderr contains "requires an interactive terminal". This verifies the TTY guard works correctly.

2. **manage command shows in help output** -- Run `pool --help` via runCLI. Assert stdout contains "manage" and "Interactive checklist" or "toggle exercises". This verifies CLI registration.

**Note on interactive testing:** Full interactive tests for CheckboxPrompt (arrow keys, space toggle, enter confirm) would require mocking stdin keypress events in a child process, which is fragile and complex. The CheckboxPrompt widget itself was already tested manually in Phase 12 (setup wizard). The manage command's logic (load pool, build choices, filter, save) follows the same proven pattern. The TTY guard test confirms the command exists and handles non-interactive contexts correctly.

If you want a more thorough test, you can add a unit test that directly calls internal helpers, but given the manage function's tight integration with terminal I/O, the TTY guard + help output tests provide sufficient coverage for an integration test suite.
  </action>
  <verify>
Run: `node --test test/cli/pool.test.js`

All tests pass including new manage tests, batch-add tests from Plan 01, and all original pool tests.
  </verify>
  <done>
- TTY guard test confirms manage rejects non-interactive contexts with exit 1
- Help output test confirms manage is registered in CLI
- All existing tests still pass
  </done>
</task>

</tasks>

<verification>
1. `node --test test/cli/pool.test.js` -- All tests pass
2. `node --test` -- Full test suite passes with no regressions
3. `echo "" | node bin/viberipped.js pool manage` -- Exits with TTY error
4. `node bin/viberipped.js pool --help` -- Shows manage subcommand
</verification>

<success_criteria>
- `viberipped pool manage` launches interactive checklist in terminal
- Checklist shows all exercises with type-aware labels, all checked by default
- Space toggles exercises, Enter saves, Escape cancels
- TTY guard prevents running in pipes/non-interactive contexts
- Cannot uncheck all exercises (empty pool guard)
- All integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-batch-checklist-management/13-02-SUMMARY.md`
</output>
