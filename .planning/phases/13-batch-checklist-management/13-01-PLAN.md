---
phase: 13-batch-checklist-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/cli/commands/pool.js
  - bin/viberipped.js
  - test/cli/pool.test.js
autonomous: true

must_haves:
  truths:
    - "User can run `viberipped pool add \"Burpees 12, Mountain climbers 20\"` to add multiple exercises at once"
    - "Batch add parses comma-separated format and validates each exercise before adding"
    - "If any exercise in the batch is invalid, none are added (atomic validation)"
    - "Duplicate detection catches both existing pool conflicts and within-batch duplicates"
    - "Single-add mode (`pool add \"Name\" 15`) still works unchanged"
  artifacts:
    - path: "lib/cli/commands/pool.js"
      provides: "addBatch function with split-trim-filter parsing, atomic validation, duplicate detection"
      contains: "addBatch"
    - path: "bin/viberipped.js"
      provides: "Updated pool add description mentioning batch format"
      contains: "batch"
    - path: "test/cli/pool.test.js"
      provides: "Integration tests for batch-add: happy path, validation error, within-batch duplicates, existing-pool duplicates, multi-word names"
      contains: "batch"
  key_links:
    - from: "lib/cli/commands/pool.js:add"
      to: "lib/cli/commands/pool.js:addBatch"
      via: "comma detection in name parameter"
      pattern: "name\\.includes\\(','\\)"
    - from: "lib/cli/commands/pool.js:addBatch"
      to: "lib/cli/validation.js"
      via: "validateExerciseName and validateReps for each parsed item"
      pattern: "validateExerciseName|validateReps"
---

<objective>
Add batch-add capability to the pool add command so users can add multiple exercises from a single comma-separated string.

Purpose: Reduces friction for bulk pool population -- users currently must run separate add commands for each exercise.
Output: Extended pool.js add function with batch detection + addBatch helper, updated CLI description, integration tests.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-batch-checklist-management/13-RESEARCH.md
@lib/cli/commands/pool.js
@lib/cli/validation.js
@bin/viberipped.js
@test/cli/pool.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Batch-add parsing and validation in pool.js</name>
  <files>lib/cli/commands/pool.js, bin/viberipped.js</files>
  <action>
Extend the existing `add()` function in `lib/cli/commands/pool.js` to detect batch mode when the `name` parameter contains a comma. When detected, delegate to a new `addBatch()` function.

**In add() function, add comma detection at the very top before existing validation:**
```javascript
if (name.includes(',')) {
  return addBatch(name, options);
}
```

**Create addBatch(batchInput, options) function that:**
1. Splits on comma: `batchInput.split(',').map(s => s.trim()).filter(s => s.length > 0)`
2. Validates non-empty result (error if 0 items parsed)
3. For each item, splits on whitespace (`item.split(/\s+/)`), takes last part as reps, joins the rest as name
4. Validates each item has at least 2 parts (name + reps), errors with clear message if not
5. Validates each name with `validateExerciseName()` and each reps with `validateReps()`
6. After ALL parsed, checks for duplicates against existing pool (case-insensitive)
7. Checks for duplicates within the batch itself using a Set of lowercased names
8. Only AFTER all validation passes, pushes all exercises to pool with fields: `{ name, reps, equipment: [], type: 'reps', environments: ['anywhere'] }`
9. Saves pool atomically with `savePool()`, updates state hash with `updateStateHash(computePoolHash(pool))`
10. Prints success message: `Added N exercises to pool` followed by list of each added exercise
11. Exits with `process.exit(0)` on success, `process.exit(1)` on any error

**Note:** Batch mode always uses type='reps' and environments=['anywhere'] defaults. Options like --type and --environments are not applied in batch mode (keep simple per research recommendation).

**In bin/viberipped.js, update the pool add command:**
- Change the `.description()` from `'Add exercise to pool'` to `'Add exercise to pool (or batch: "Name1 reps1, Name2 reps2")'`
- No other CLI changes needed -- Commander passes the full quoted string as the `name` parameter when batch format is used

**Export addBatch alongside existing exports (add it to module.exports).**
  </action>
  <verify>
Run existing tests to confirm no regression: `node --test test/cli/pool.test.js`

All existing pool tests must still pass (single-add, duplicate rejection, timed exercises, environment tagging, etc.)
  </verify>
  <done>
- add() detects comma in name and delegates to addBatch()
- addBatch() parses "Name reps, Name2 reps2" format correctly
- Validation is atomic: all-or-nothing
- Duplicate detection covers both pool conflicts and within-batch
- Existing single-add behavior is unchanged
- addBatch is exported from pool.js module.exports
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for batch-add</name>
  <files>test/cli/pool.test.js</files>
  <action>
Add a new `describe('pool batch add', ...)` block inside the existing `describe('pool command', ...)` in `test/cli/pool.test.js`. Follow the existing test patterns (isolated tempHome, createPool helper, runCLI, cleanup).

**Tests to add:**

1. **batch adds multiple exercises from comma-separated input** -- Create pool with 1 exercise, run `pool add "Burpees 12, Mountain climbers 20, Jumping jacks 30"`, assert exit 0, assert stdout matches /Added 3 exercises/, verify pool.json has 4 total exercises (1 original + 3 new), verify each new exercise has correct name and reps.

2. **batch add rejects if any exercise has invalid format (missing reps)** -- Run `pool add "Burpees 12, Invalid, Squats 20"`, assert exit 1, assert stderr matches /Invalid format/, verify pool.json unchanged (only original exercise, Burpees NOT added -- atomic failure).

3. **batch add rejects if reps are invalid** -- Run `pool add "Burpees 12, Squats abc"`, assert exit 1, assert stderr matches /Invalid reps/, verify pool unchanged.

4. **batch add rejects duplicate within batch** -- Run `pool add "Burpees 12, Squats 20, Burpees 15"`, assert exit 1, assert stderr matches /Duplicate exercise.*batch.*Burpees/i, verify pool unchanged.

5. **batch add rejects duplicate against existing pool** -- Create pool with "Pushups", run `pool add "Burpees 12, Pushups 20"`, assert exit 1, assert stderr matches /already exists/, verify pool unchanged.

6. **batch add handles multi-word exercise names** -- Run `pool add "Jumping jacks 30, Mountain climbers 20, High knees 25"`, assert exit 0, verify pool contains exercises with correct multi-word names preserved.

7. **batch add handles extra whitespace** -- Run `pool add "Burpees  12 ,  Squats   20"`, assert exit 0, assert 2 exercises added with correct names and reps.

8. **batch add resets state index** -- Create state.json with currentIndex > 0, run batch add, verify state.json currentIndex is 0.

Each test uses fresh tempHome, creates initial pool, runs CLI, asserts output/exit code, verifies pool.json on disk, and calls cleanup.
  </action>
  <verify>
Run: `node --test test/cli/pool.test.js`

All tests pass including new batch-add tests and existing pool tests.
  </verify>
  <done>
- 8 new integration tests covering batch-add happy path, format errors, reps errors, within-batch duplicates, pool duplicates, multi-word names, whitespace handling, and state reset
- All existing pool tests still pass
- Tests verify atomic behavior (no partial imports on error)
  </done>
</task>

</tasks>

<verification>
1. `node --test test/cli/pool.test.js` -- All tests pass (existing + new batch tests)
2. `node --test` -- Full test suite passes with no regressions
3. Manual smoke test: `viberipped pool add "Test1 10, Test2 20"` adds both exercises
</verification>

<success_criteria>
- Batch add command works: `viberipped pool add "Burpees 12, Mountain climbers 20"` adds both
- Single add still works: `viberipped pool add "Burpees" 12` adds one
- Invalid batch fails atomically with clear error message
- Duplicates (within batch and against pool) are rejected
- All integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-batch-checklist-management/13-01-SUMMARY.md`
</output>
