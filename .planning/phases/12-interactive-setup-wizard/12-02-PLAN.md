---
phase: 12-interactive-setup-wizard
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - lib/cli/commands/setup.js
  - bin/vibripped.js
  - test/cli/setup.test.js
autonomous: false

must_haves:
  truths:
    - "User can run 'vibripped setup' to launch interactive wizard"
    - "Wizard detects non-TTY and fails with exit 1 plus helpful alternative commands"
    - "Wizard presents checkbox list of equipment options (kettlebell, dumbbells, pull-up bar, parallettes)"
    - "Wizard creates configuration and pool files based on selected equipment"
    - "Wizard asks before overwriting existing configuration"
    - "Default exercises are suggested based on selected equipment via assemblePool"
  artifacts:
    - path: "lib/cli/commands/setup.js"
      provides: "Setup wizard command handler with TTY guard, equipment selection, config/pool generation"
      exports: ["setup"]
    - path: "bin/vibripped.js"
      provides: "CLI with setup command registered"
      contains: "setup"
    - path: "test/cli/setup.test.js"
      provides: "Integration tests for setup command non-TTY detection and CLI registration"
  key_links:
    - from: "lib/cli/commands/setup.js"
      to: "lib/cli/ui/tty.js"
      via: "requireTTY guard at entry"
      pattern: "requireTTY.*setup"
    - from: "lib/cli/commands/setup.js"
      to: "lib/cli/ui/checkbox.js"
      via: "CheckboxPrompt for equipment selection"
      pattern: "new CheckboxPrompt"
    - from: "lib/cli/commands/setup.js"
      to: "lib/cli/ui/confirm.js"
      via: "confirm prompt for overwrite check"
      pattern: "confirm\\("
    - from: "lib/cli/commands/setup.js"
      to: "lib/config.js"
      via: "saveConfig for persisting equipment choices"
      pattern: "saveConfig"
    - from: "lib/cli/commands/setup.js"
      to: "lib/pool.js"
      via: "assemblePool for generating exercise pool from equipment"
      pattern: "assemblePool"
    - from: "bin/vibripped.js"
      to: "lib/cli/commands/setup.js"
      via: "Commander command registration"
      pattern: "command.*setup"
---

<objective>
Wire the setup wizard command: TTY guard, equipment checkbox selection, config/pool generation, overwrite protection, CLI registration, and integration tests.

Purpose: This is the user-facing feature -- running `vibripped setup` launches a guided first-time experience that replaces manual config flag juggling.

Output: Working `vibripped setup` command with integration tests and manual verification.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-interactive-setup-wizard/12-RESEARCH.md
@.planning/phases/12-interactive-setup-wizard/12-01-SUMMARY.md
@lib/cli/commands/config.js
@lib/config.js
@lib/pool.js
@lib/state.js
@lib/cli/output.js
@bin/vibripped.js
@test/cli/config.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup command handler and CLI registration</name>
  <files>lib/cli/commands/setup.js, bin/vibripped.js</files>
  <action>
**lib/cli/commands/setup.js** - Setup wizard command handler:

Export async `setup()` function with this flow:

1. **TTY guard** -- Call `requireTTY('setup')` from `lib/cli/ui/tty.js`. If false, return immediately (requireTTY already sets exitCode and prints error).

2. **Check existing config** -- Use `getConfigPath()` from config module. Check if file exists with `fs.existsSync()`. If exists:
   - Call `confirm('Existing configuration found. Overwrite?')` from `lib/cli/ui/confirm.js`
   - If user says no, print `info('Setup cancelled. Existing configuration preserved.')` and return with exitCode 0
   - If yes, continue to step 3

3. **Welcome message** -- Print:
   ```
   info('')
   info('Welcome to VibeRipped setup!')
   info('Select your available equipment using arrow keys and space bar.')
   info('Press Enter when done.')
   info('')
   ```

4. **Equipment selection** -- Create CheckboxPrompt with choices:
   ```javascript
   [
     { label: 'Kettlebell', value: 'kettlebell', checked: false },
     { label: 'Dumbbells', value: 'dumbbells', checked: false },
     { label: 'Pull-up bar', value: 'pullUpBar', checked: false },
     { label: 'Parallettes', value: 'parallettes', checked: false },
   ]
   ```
   Message: `'Select equipment (Space to toggle, Enter to confirm):'`

   Wrap `prompt()` in try/catch. If user cancels (Escape), print `info('Setup cancelled.')` and return with exitCode 0.

5. **Build config** -- Create config object:
   ```javascript
   {
     equipment: {
       kettlebell: selected.includes('kettlebell'),
       dumbbells: selected.includes('dumbbells'),
       pullUpBar: selected.includes('pullUpBar'),
       parallettes: selected.includes('parallettes'),
     },
     difficulty: { multiplier: 1.0 },
     environment: 'anywhere',
     schemaVersion: '1.0'
   }
   ```

6. **Save config** -- Call `saveConfig(configPath, config)`.

7. **Generate pool** -- Call `assemblePool(config)` to get equipment-filtered exercises. Write pool.json atomically using `writeFileAtomic.sync()` to `path.join(getStateDir(), 'pool.json')` with mode 0o600. Create state dir first with `fs.mkdirSync(stateDir, { recursive: true, mode: 0o700 })`.

8. **Print summary** -- Show what was configured:
   ```
   success('Setup complete!')
   info('')
   ```
   List enabled equipment or "bodyweight only" if none selected.
   Print `info('Pool generated with {N} exercises.')`.
   Print `info('')`.
   Print `info('Next steps:')`.
   Print `info('  vibripped test     Preview your first exercise')`.
   Print `info('  vibripped harder   Increase difficulty')`.
   Print `info('  vibripped softer   Decrease difficulty')`.

Set `process.exitCode = 0`.

**Requires:** Use `path.join(__dirname, '../../...')` pattern for all requires (consistent with other command handlers). Require:
- `lib/cli/ui/tty.js` for requireTTY
- `lib/cli/ui/checkbox.js` for CheckboxPrompt
- `lib/cli/ui/confirm.js` for confirm
- `lib/config.js` for loadConfig, saveConfig, getConfigPath
- `lib/pool.js` for assemblePool, computePoolHash
- `lib/state.js` for getStateDir
- `lib/cli/output.js` for success, error, info
- `write-file-atomic` for atomic pool write
- `fs` for existsSync, mkdirSync
- `path` for path.join

**bin/vibripped.js** -- Add setup command registration:

Add before the `// Show help if no arguments` block:
```javascript
// Setup command - interactive first-time setup wizard
program
  .command('setup')
  .description('Launch interactive setup wizard for first-time configuration')
  .action(async () => {
    const setupHandler = require(path.join(__dirname, '../lib/cli/commands/setup.js'));
    await setupHandler();
  });
```

Note: The action must be async since setup() is async (uses await for checkbox prompt and confirm).
  </action>
  <verify>`node bin/vibripped.js --help` shows setup command. `echo '' | node bin/vibripped.js setup` exits with code 1 and stderr contains "requires interactive terminal".</verify>
  <done>Setup command registered in CLI, wizard flow implements all 6 success criteria: TTY guard, equipment checkbox, config generation, pool generation, overwrite protection, helpful next steps.</done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for setup command</name>
  <files>test/cli/setup.test.js</files>
  <action>
Create `test/cli/setup.test.js` following existing test patterns from `test/cli/config.test.js`.

**Test helper:** Reuse the `runCLI(args)` pattern: spawn `bin/vibripped.js` with isolated temp HOME/XDG_CONFIG_HOME, capture stdout/stderr/code, cleanup temp dir.

**Tests:**

1. `setup command appears in help` -- Run `['--help']`, assert stdout contains 'setup'.

2. `setup fails gracefully in non-TTY mode` -- Run `['setup']` with `stdio: ['ignore', 'pipe', 'pipe']` (stdin not connected = not a TTY). Assert:
   - Exit code 1
   - stderr contains "requires interactive terminal"
   - stderr contains "vibripped config" (alternative suggestion)

3. `setup fails gracefully when stdout is not TTY` -- Run `['setup']` with `stdio: ['pipe', 'pipe', 'pipe']`. Pipe stdin but don't write. Assert exit code 1, stderr mentions TTY requirement. (This tests the stdout.isTTY check path.)

4. `setup creates config and pool on fresh directory` -- This test is harder without interactive input. Instead, test the module directly:
   - Require `lib/cli/commands/setup.js`
   - Verify it exports a function
   - Verify the module loads without error

5. `setup --help shows description` -- Run `['setup', '--help']`, assert stdout contains 'interactive setup wizard' or 'first-time'.

**Note:** Full interactive flow testing (arrow keys, space bar) requires a PTY and is covered by the manual checkpoint below. Non-TTY detection is the critical safety test (prevents breaking statusline pipe mode).

All tests must pass with `node --test test/cli/setup.test.js`.
  </action>
  <verify>`node --test test/cli/setup.test.js` passes all tests. `node --test` (full suite) still passes.</verify>
  <done>Setup command integration tests verify non-TTY rejection, help text presence, and module loading. Full test suite passes with no regressions.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Interactive setup wizard with checkbox equipment selection, TTY detection, config/pool generation, and overwrite protection.</what-built>
  <how-to-verify>
    1. Run `vibripped setup` in your terminal
    2. Verify you see welcome message and equipment checkbox list
    3. Use arrow keys to navigate up/down between equipment options
    4. Press Space to toggle checkboxes on/off (verify Unicode checkboxes render)
    5. Select at least kettlebell and dumbbells, press Enter
    6. Verify success message shows selected equipment and pool count
    7. Run `vibripped config` to confirm equipment was saved
    8. Run `vibripped pool list` to confirm exercises were generated
    9. Run `vibripped setup` again to verify overwrite prompt appears
    10. Type 'n' at overwrite prompt to verify config is preserved
    11. Press Ctrl+C during wizard to verify terminal state is restored (cursor visible, echo works)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `vibripped setup` launches interactive wizard in TTY
- `vibripped setup` fails with exit 1 and helpful error in non-TTY context
- Equipment selection via checkbox widget works (arrows, space, enter)
- Config and pool files created at ~/.config/viberipped/
- Overwrite prompt appears when config already exists
- Ctrl+C and Escape cleanly exit without terminal corruption
- `node --test` full suite passes with no regressions
</verification>

<success_criteria>
- `vibripped setup` registered in CLI and appears in --help
- TTY detection prevents execution in pipe mode (critical for statusline safety)
- Checkbox presents all 4 equipment options with toggle
- Selected equipment saved to configuration.json
- Pool assembled from selected equipment and saved to pool.json
- Existing config triggers overwrite confirmation prompt
- Terminal state always restored (no raw mode leaks)
- All new and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-interactive-setup-wizard/12-02-SUMMARY.md`
</output>
