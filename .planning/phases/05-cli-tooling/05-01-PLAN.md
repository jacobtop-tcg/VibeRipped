---
phase: 05-cli-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bin/vibripped.js
  - lib/cli/validation.js
  - lib/cli/output.js
  - lib/cli/commands/config.js
  - lib/cli/commands/test.js
  - engine.js
autonomous: true

must_haves:
  truths:
    - "User can run vibripped config --kettlebell --dumbbells to declare equipment"
    - "User can run vibripped config with no flags to see current equipment"
    - "User can run vibripped config --no-kettlebell to disable equipment"
    - "User can run vibripped test to preview next exercise without advancing state"
    - "CLI commands exit 0 on success and exit 1 on error with clear messages"
    - "vibripped with no arguments shows help text"
  artifacts:
    - path: "bin/vibripped.js"
      provides: "CLI entry point with commander subcommands"
      contains: "#!/usr/bin/env node"
    - path: "lib/cli/validation.js"
      provides: "Input validation helpers for name and reps"
      exports: ["validateExerciseName", "validateReps"]
    - path: "lib/cli/output.js"
      provides: "Formatted output helpers for success and error"
      exports: ["success", "error", "info"]
    - path: "lib/cli/commands/config.js"
      provides: "Config command: set/show equipment flags"
      min_lines: 30
    - path: "lib/cli/commands/test.js"
      provides: "Test command: dry-run exercise preview"
      min_lines: 15
    - path: "engine.js"
      provides: "trigger() with dryRun option to skip state persistence"
      contains: "dryRun"
    - path: "package.json"
      provides: "bin field mapping vibripped to bin/vibripped.js, commander dependency"
      contains: "commander"
  key_links:
    - from: "bin/vibripped.js"
      to: "lib/cli/commands/config.js"
      via: "commander .action() handler"
      pattern: "require.*commands/config"
    - from: "bin/vibripped.js"
      to: "lib/cli/commands/test.js"
      via: "commander .action() handler"
      pattern: "require.*commands/test"
    - from: "lib/cli/commands/test.js"
      to: "engine.js"
      via: "trigger(null, { bypassCooldown: true, dryRun: true })"
      pattern: "trigger.*dryRun"
    - from: "lib/cli/commands/config.js"
      to: "lib/config.js"
      via: "loadConfig/saveConfig for equipment persistence"
      pattern: "require.*config"
---

<objective>
Create the VibeRipped CLI scaffold with commander.js, implement the config and test commands, and add dryRun support to engine.js.

Purpose: Establishes the CLI entry point and two of three command categories (config for equipment setup, test for dry-run preview). After this plan, users can configure equipment and test exercise rotation via command line.

Output: Executable `vibripped` CLI with `config` and `test` subcommands, plus validation/output helpers for use by all commands.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cli-tooling/05-RESEARCH.md
@engine.js
@lib/config.js
@lib/state.js
@lib/pool.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commander scaffold, package.json, validation and output helpers</name>
  <files>
    package.json
    bin/vibripped.js
    lib/cli/validation.js
    lib/cli/output.js
  </files>
  <action>
1. Install commander: `npm install commander@^14.0.0`

2. Update package.json: Add `"bin": { "vibripped": "./bin/vibripped.js" }` field. Keep all existing fields.

3. Create bin/vibripped.js with shebang `#!/usr/bin/env node`:
   - Require commander's Command class
   - Set program name 'vibripped', description 'VibeRipped CLI - Deterministic micro-exercise rotation', version from package.json
   - Register 'config' subcommand with equipment boolean options: `--kettlebell`, `--dumbbells`, `--pull-up-bar`, `--parallettes`. Use commander's negatable option pattern for each: `.option('--kettlebell', 'Enable kettlebell exercises')` and `.option('--no-kettlebell', 'Disable kettlebell exercises')`. Action handler requires and calls lib/cli/commands/config.js.
   - Register 'pool' subcommand group with three sub-subcommands: 'list' (aliases: 'ls'), 'add <name> <reps>' (adds exercise), 'remove <name>' (aliases: 'rm'). Action handlers require and call lib/cli/commands/pool.js methods. NOTE: Commander does not support nested subcommands with `program.command('pool list')` syntax. Instead, create a pool command with `.command('pool')`, then use `.addCommand()` to attach list/add/remove as sub-commands of the pool command. Alternatively, use flat commands: `pool-list`, `pool-add`, `pool-remove` if nesting proves complex. Simplest approach: create pool as its own Command instance with sub-commands, then add it via `program.addCommand(poolCmd)`.
   - Register 'test' subcommand: description 'Preview next exercise without advancing rotation'. Action handler requires and calls lib/cli/commands/test.js.
   - If `process.argv.length === 2`, call `program.outputHelp()`.
   - Call `program.parse(process.argv)`.
   - Use `path.join(__dirname, '../lib/cli/commands/...')` for all requires to avoid relative path issues (Pitfall 9 from research).

4. Create lib/cli/validation.js:
   - `validateExerciseName(name)`: Returns trimmed name or null. Checks: non-empty string, max 50 chars. Does NOT call process.exit (caller decides).
   - `validateReps(repsStr)`: Returns parsed integer or null. Checks: valid integer, range 1-999. Does NOT call process.exit.
   - Export both functions.

5. Create lib/cli/output.js:
   - `success(message)`: Prints checkmark prefix to stdout: `console.log('OK ' + message)` (use literal "OK" not emoji, matching project's crisp output philosophy -- but research uses checkmark, so use Unicode checkmark U+2713 since project already uses Unicode in orchestrator).
   - `error(message, usage)`: Prints "Error: {message}" to stderr. If usage provided, prints "Usage: {usage}" to stderr. Sets process.exitCode = 1.
   - `info(message)`: Prints message to stdout (no prefix).
   - Export all three.

6. Make bin/vibripped.js executable: `chmod +x bin/vibripped.js`
  </action>
  <verify>
    Run `node bin/vibripped.js --help` and confirm it shows program description with config, pool, test subcommands listed. Run `node bin/vibripped.js --version` and confirm it shows 0.1.0.
  </verify>
  <done>bin/vibripped.js shows help with all subcommands, --version works, validation and output modules export their functions</done>
</task>

<task type="auto">
  <name>Task 2: Config command implementation</name>
  <files>lib/cli/commands/config.js</files>
  <action>
Create lib/cli/commands/config.js that wraps existing lib/config.js:

1. The function receives commander options object. Equipment flags come as boolean (true if --flag, false if --no-flag, undefined if not specified).

2. **Show mode** (no equipment flags specified): All four equipment keys are undefined in options.
   - Load current config via `loadConfig(getConfigPath())`
   - Print formatted equipment list using output.info():
     ```
     Current equipment configuration:
       Kettlebell:   enabled/disabled
       Dumbbells:    enabled/disabled
       Pull-up bar:  enabled/disabled
       Parallettes:  enabled/disabled
     ```
   - Exit with code 0.

3. **Set mode** (at least one flag specified):
   - Load current config via `loadConfig(getConfigPath())`
   - Merge: for each equipment key, if CLI option is not undefined, use it; otherwise keep current value. Map commander's camelCase options (pullUpBar from --pull-up-bar) to config keys.
   - Validate merged config via `validateConfig()`.
   - Save via `saveConfig(getConfigPath(), newConfig)`.
   - Print confirmation: "Configuration updated" with equipment summary.
   - Print "Pool will regenerate on next trigger." as info.
   - Exit with code 0.

4. Error handling: If saveConfig fails silently (it logs to stderr), the CLI should still exit 0 since saveConfig doesn't throw. If validateConfig returns false, print error and exit 1.

5. Use path.join(__dirname, '../../config') for require paths (relative to lib/cli/commands/).

NOTE: Commander maps --pull-up-bar to options.pullUpBar automatically (camelCase conversion). Verify this maps correctly to config.equipment.pullUpBar.
  </action>
  <verify>
    Run `node bin/vibripped.js config` to show defaults (all disabled). Run `node bin/vibripped.js config --kettlebell --dumbbells` and verify it reports updated. Run `node bin/vibripped.js config` again and verify kettlebell/dumbbells show enabled. Run `node bin/vibripped.js config --no-kettlebell` and verify kettlebell reverts to disabled.
  </verify>
  <done>Config command shows current equipment when called with no flags, sets equipment when called with flags, supports --no-{flag} negation, persists to configuration.json</done>
</task>

<task type="auto">
  <name>Task 3: Test command with engine.js dryRun support</name>
  <files>
    engine.js
    lib/cli/commands/test.js
  </files>
  <action>
1. Modify engine.js trigger() function to support dryRun option:
   - Add `options.dryRun` check. When true, skip the state save block (lines ~197-200 where fs.mkdirSync + fs.writeFileSync happen). The state object is still mutated in memory (currentIndex advances, timestamps update) but nothing writes to disk.
   - This is a minimal change: wrap the existing save block in `if (!options.dryRun) { ... }`.
   - Do NOT change any other behavior. The function still returns the same response object.

2. Create lib/cli/commands/test.js:
   - Requires engine.js trigger() via `path.join(__dirname, '../../../engine')`.
   - Calls `trigger(null, { bypassCooldown: true, dryRun: true })`.
   - On success (result.type === 'exercise'):
     ```
     Next exercise: {result.prompt}
     Position: {current+1} of {total}
     Total triggered: {totalTriggered}

     (dry-run: rotation state unchanged)
     ```
   - On unexpected result, print error and exit 1.
   - Wrap in try/catch. On error, print error message and exit 1.
   - Exit 0 on success.

3. The test command is intentionally simple: it previews what the NEXT trigger would produce without affecting real state. The bypassCooldown ensures it always shows an exercise (never a cooldown response). The dryRun ensures the state file is untouched.
  </action>
  <verify>
    Run `node bin/vibripped.js test` twice. Both runs should show the same exercise name and same position number, proving state is not advancing. Run `node bin/vibripped.js test` and verify output includes exercise name, position, and dry-run notice.
  </verify>
  <done>Test command shows next exercise without advancing rotation state. Running it multiple times produces identical output. engine.js dryRun flag prevents state file writes.</done>
</task>

</tasks>

<verification>
1. `node bin/vibripped.js --help` shows all subcommands (config, pool, test)
2. `node bin/vibripped.js config --kettlebell` updates configuration.json and reports success
3. `node bin/vibripped.js config` shows current equipment state
4. `node bin/vibripped.js config --no-kettlebell` disables equipment
5. `node bin/vibripped.js test` shows exercise without changing state.json
6. `node bin/vibripped.js test && node bin/vibripped.js test` shows same exercise both times
7. `node --test` (existing tests) still pass â€” no regressions from engine.js change
8. `node bin/vibripped.js` with no args shows help
</verification>

<success_criteria>
- vibripped CLI executable with help, version, and three registered subcommands
- Config command reads/writes equipment configuration with negatable flags
- Test command previews next exercise without mutating state on disk
- engine.js dryRun option prevents state persistence while preserving all other behavior
- All existing tests pass (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/05-cli-tooling/05-01-SUMMARY.md`
</output>
