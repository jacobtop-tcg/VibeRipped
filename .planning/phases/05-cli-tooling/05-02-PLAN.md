---
phase: 05-cli-tooling
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - bin/vibripped.js
  - lib/cli/commands/pool.js
  - test/cli/config.test.js
  - test/cli/pool.test.js
  - test/cli/test.test.js
autonomous: true

must_haves:
  truths:
    - "User can list all exercises in current pool with names, reps, and equipment tags"
    - "User can add a custom exercise with name and reps to the pool"
    - "User can remove an exercise from the pool by name"
    - "Adding an exercise updates pool.json and resets rotation index in state.json"
    - "Removing an exercise updates pool.json and resets rotation index in state.json"
    - "Duplicate exercise names are rejected with clear error"
    - "Invalid reps values are rejected with clear error"
    - "Removing non-existent exercise is rejected with clear error"
    - "All CLI commands return correct exit codes (0 success, 1 error)"
  artifacts:
    - path: "lib/cli/commands/pool.js"
      provides: "Pool list, add, remove command implementations"
      exports: ["list", "add", "remove"]
      min_lines: 80
    - path: "test/cli/config.test.js"
      provides: "Integration tests for config command"
      min_lines: 30
    - path: "test/cli/pool.test.js"
      provides: "Integration tests for pool list/add/remove"
      min_lines: 50
    - path: "test/cli/test.test.js"
      provides: "Integration tests for test/dry-run command"
      min_lines: 30
  key_links:
    - from: "lib/cli/commands/pool.js"
      to: "lib/pool.js"
      via: "computePoolHash for hash recalculation"
      pattern: "computePoolHash"
    - from: "lib/cli/commands/pool.js"
      to: "lib/state.js"
      via: "getStateDir for file paths"
      pattern: "getStateDir"
    - from: "lib/cli/commands/pool.js"
      to: "state.json"
      via: "poolHash update + currentIndex reset after add/remove"
      pattern: "poolHash.*currentIndex"
    - from: "test/cli/*.test.js"
      to: "bin/vibripped.js"
      via: "child_process.spawn for end-to-end CLI testing"
      pattern: "spawn.*vibripped"
---

<objective>
Implement pool management commands (list, add, remove) and comprehensive integration tests for all CLI commands.

Purpose: Completes the CLI tooling by enabling users to manage their exercise pool without manual JSON editing, and validates all commands work end-to-end via integration tests. After this plan, all Phase 5 success criteria are met.

Output: Working pool list/add/remove commands with state re-indexing, plus integration test suite covering config, pool, and test commands.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cli-tooling/05-RESEARCH.md
@.planning/phases/05-cli-tooling/05-01-SUMMARY.md
@engine.js
@lib/config.js
@lib/state.js
@lib/pool.js
@lib/cli/validation.js
@lib/cli/output.js
@bin/vibripped.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Pool list, add, and remove commands</name>
  <files>
    lib/cli/commands/pool.js
  </files>
  <action>
Create lib/cli/commands/pool.js with three exported functions: list, add, remove.

**list():**
- Get pool.json path via `path.join(getStateDir(), 'pool.json')`.
- Read and parse pool.json. If file missing (ENOENT), print error: "No pool found. Run setup first: vibripped config --kettlebell" and exit 1.
- If pool is not an array or is empty, print error and exit 1.
- Print header: "Exercise pool ({N} exercises):" followed by blank line.
- For each exercise, print numbered line: `  {i+1}. {name} x{reps} [{equipment}]` where equipment is comma-joined equipment array or "bodyweight" if empty array or no equipment field.
- Exit 0.

**add(name, repsStr):**
- Validate name via validateExerciseName() from validation.js. If null, print error with usage "vibripped pool add \"Exercise name\" <reps>" and exit 1.
- Validate reps via validateReps() from validation.js. If null, print error with usage and exit 1.
- Load pool.json. If missing, print error directing user to run config first, exit 1.
- Check for duplicate: case-insensitive name match against existing pool. If found, print "Exercise \"{name}\" already exists in pool" and exit 1.
- Append new exercise object: `{ name: trimmedName, reps: parsedReps, equipment: [] }` (custom exercises have no equipment tag).
- Compute new pool hash via computePoolHash(updatedPool).
- Write pool.json atomically via write-file-atomic with mode 0o600 and 2-space indent.
- Load state.json, update state.poolHash to new hash, reset state.currentIndex to 0, write state.json atomically.
- If state.json doesn't exist or fails to parse, that's fine (state will initialize on next trigger).
- Print: "Added \"{name}\" x{reps} to pool" and "Rotation index reset to beginning."
- Exit 0.

**remove(name):**
- Validate name is non-empty. If empty, print error with usage "vibripped pool remove \"Exercise name\"" and exit 1.
- Load pool.json. If missing, print error and exit 1.
- Find exercise by case-insensitive name match. If not found, print "Exercise \"{name}\" not found in pool" and exit 1.
- If pool would become empty after removal (length === 1), print "Cannot remove last exercise from pool" and exit 1.
- Remove the exercise from array (filter it out).
- Compute new pool hash, write pool.json atomically.
- Update state.json poolHash and reset currentIndex to 0 (same pattern as add).
- Print: "Removed \"{matched name}\" from pool" and "Rotation index reset to beginning."
- Exit 0.

**Shared concerns:**
- Use require(path.join(__dirname, '../../pool')) for computePoolHash.
- Use require(path.join(__dirname, '../../state')) for getStateDir.
- Use require('write-file-atomic') for atomic writes.
- Use require(path.join(__dirname, '../validation')) for validators.
- Use require(path.join(__dirname, '../output')) for formatted output.
- All file operations wrapped in try/catch with clear error messages.
  </action>
  <verify>
    Run `node bin/vibripped.js config --kettlebell` to generate pool, then:
    1. `node bin/vibripped.js pool list` shows exercises with numbers and equipment tags
    2. `node bin/vibripped.js pool add "Burpees" 10` succeeds and shows confirmation
    3. `node bin/vibripped.js pool list` now includes Burpees
    4. `node bin/vibripped.js pool add "Burpees" 10` fails with duplicate error
    5. `node bin/vibripped.js pool remove "Burpees"` succeeds
    6. `node bin/vibripped.js pool list` no longer includes Burpees
    7. `node bin/vibripped.js pool remove "Nonexistent"` fails with not-found error
  </verify>
  <done>Pool list shows all exercises with equipment tags. Pool add validates inputs, rejects duplicates, appends exercise, updates hash, resets index. Pool remove validates inputs, rejects non-existent, removes exercise, updates hash, resets index. Cannot remove last exercise.</done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for all CLI commands</name>
  <files>
    test/cli/config.test.js
    test/cli/pool.test.js
    test/cli/test.test.js
  </files>
  <action>
Create integration tests using Node.js built-in test runner and child_process.spawn. Each test file spawns `node bin/vibripped.js` as a subprocess and asserts on stdout, stderr, and exit code.

**Test helper (inline in each file or shared):**
Create a `runCLI(args, env)` helper function that:
- Spawns `node {path.join(__dirname, '../../bin/vibripped.js')} ...args`
- Sets HOME env var to a temp directory (os.tmpdir() + unique suffix) to isolate XDG_CONFIG_HOME and prevent interference with real user state. Set XDG_CONFIG_HOME to `path.join(tempHome, '.config')`.
- Captures stdout and stderr as strings.
- Returns Promise resolving to `{ code, stdout, stderr }`.
- Each test creates its own temp dir and cleans up after (rm -rf).

**test/cli/config.test.js:**
1. "shows default config when no flags" — run `config`, expect exit 0, stdout contains "disabled" for all four equipment types
2. "sets equipment flags" — run `config --kettlebell --dumbbells`, expect exit 0, stdout contains "enabled" for kettlebell and dumbbells
3. "persists config across calls" — run `config --kettlebell`, then run `config`, expect stdout shows kettlebell enabled
4. "negates equipment with --no-flag" — run `config --kettlebell`, then `config --no-kettlebell`, then `config`, expect kettlebell disabled
5. "shows help for config subcommand" — run `config --help`, expect exit 0, stdout contains equipment option descriptions

**test/cli/pool.test.js:**
1. "lists exercises after config" — run `config --kettlebell` to generate pool, then trigger engine once to create pool.json (or manually create pool.json by triggering), then run `pool list`, expect exit 0 and exercise names in stdout. NOTE: pool.json is created by engine trigger, not by config command. So either: (a) trigger the engine first, or (b) the test runs `config --kettlebell` then calls trigger programmatically, or (c) write pool.json manually in the temp dir. Simplest: write a minimal pool.json in the test's XDG_CONFIG_HOME/viberipped/ directory before running the CLI.
2. "pool list shows error when no pool exists" — run `pool list` with empty state dir, expect exit 1 and error message
3. "adds exercise to pool" — create pool.json with default exercises, run `pool add "Burpees" 10`, expect exit 0 and confirmation
4. "rejects duplicate exercise" — create pool.json with "Pushups", run `pool add "Pushups" 15`, expect exit 1 and duplicate error
5. "rejects invalid reps" — run `pool add "Test" abc`, expect exit 1 and error about reps
6. "removes exercise from pool" — create pool.json with multiple exercises, run `pool remove "Pushups"`, expect exit 0 and confirmation
7. "rejects removing non-existent exercise" — run `pool remove "Nonexistent"`, expect exit 1
8. "resets state index after add" — create pool.json and state.json with currentIndex > 0, run `pool add "New" 10`, read state.json, verify currentIndex is 0

**test/cli/test.test.js:**
1. "shows next exercise in dry-run mode" — create pool.json and state.json, run `test`, expect exit 0 and stdout contains exercise name and "dry-run"
2. "does not advance state" — create pool.json and state.json with known currentIndex, run `test`, read state.json after, verify currentIndex unchanged
3. "shows error when no pool exists" — run `test` with empty state dir, expect exit 1 or error output (engine will initialize defaults)

For pool tests that need pool.json to exist: create the temp state dir and write a minimal pool.json array directly (e.g., `[{"name":"Pushups","reps":15,"equipment":[]},{"name":"Squats","reps":20,"equipment":[]}]`) before running the CLI command. This avoids needing to trigger the engine.

Use `fs.mkdirSync(stateDir, { recursive: true })` and `fs.writeFileSync(poolPath, ...)` in test setup.

All tests use `describe()` blocks grouped by command and `test()` for individual cases. Use `assert.strictEqual` for exit codes and `assert.match` for stdout/stderr patterns.
  </action>
  <verify>
    Run `node --test test/cli/` to execute all CLI integration tests. All tests should pass. Run `node --test` to verify no regressions in existing tests.
  </verify>
  <done>Integration tests cover all CLI commands: config (show, set, negate), pool (list, add, remove, duplicate rejection, invalid input, state reset), test (dry-run output, state preservation). All tests pass alongside existing test suite.</done>
</task>

</tasks>

<verification>
1. `node bin/vibripped.js pool list` shows exercises with numbers and equipment
2. `node bin/vibripped.js pool add "Custom exercise" 10` adds and confirms
3. `node bin/vibripped.js pool add "Custom exercise" 10` (again) rejects as duplicate
4. `node bin/vibripped.js pool remove "Custom exercise"` removes and confirms
5. `node bin/vibripped.js pool remove "Nonexistent"` exits 1 with clear error
6. After pool add/remove, state.json currentIndex is reset to 0
7. `node --test test/cli/` — all integration tests pass
8. `node --test` — all tests pass (existing + new, no regressions)
</verification>

<success_criteria>
- Pool list displays all exercises with index, name, reps, and equipment type
- Pool add validates name/reps, rejects duplicates, appends to pool.json, updates state hash, resets index
- Pool remove validates name, rejects non-existent, removes from pool.json, updates state hash, resets index
- Cannot remove last exercise from pool
- Integration tests cover all happy paths and error cases for all three command categories
- Full test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-cli-tooling/05-02-SUMMARY.md`
</output>
