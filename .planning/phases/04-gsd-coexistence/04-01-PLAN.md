---
phase: 04-gsd-coexistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/statusline/format.js
  - statusline.js
  - statusline-orchestrator.sh
  - test/statusline.test.js
  - test/orchestrator.test.js
autonomous: true

must_haves:
  truths:
    - "VibeRipped output includes a visual prefix that distinguishes it from GSD output"
    - "Orchestrator script forwards stdin to both GSD and VibeRipped and concatenates their outputs"
    - "Orchestrator handles empty outputs gracefully without orphaned separators"
    - "One provider failing does not break the other provider's output"
  artifacts:
    - path: "lib/statusline/format.js"
      provides: "formatExercise with optional prefix parameter"
      exports: ["formatExercise", "ANSI"]
      contains: "prefix"
    - path: "statusline.js"
      provides: "Statusline entry point passing prefix to formatExercise"
      contains: "prefix"
    - path: "statusline-orchestrator.sh"
      provides: "Multi-provider orchestrator shell script"
      contains: "STDIN_DATA"
    - path: "test/orchestrator.test.js"
      provides: "Orchestrator integration tests"
      min_lines: 30
  key_links:
    - from: "statusline.js"
      to: "lib/statusline/format.js"
      via: "formatExercise call with prefix option"
      pattern: "formatExercise.*prefix"
    - from: "statusline-orchestrator.sh"
      to: "statusline.js"
      via: "echo stdin data | node statusline.js"
      pattern: "node.*statusline\\.js"
    - from: "statusline-orchestrator.sh"
      to: "gsd-statusline.js"
      via: "echo stdin data | node gsd-statusline.js"
      pattern: "gsd-statusline"
---

<objective>
Add visual identity prefix to VibeRipped output and create an orchestrator shell script that composes GSD and VibeRipped statusline outputs into a single composite line.

Purpose: Enables both statusline providers to coexist in Claude Code's single statusline slot without crosstalk or visual ambiguity.
Output: Modified format.js with prefix support, updated statusline.js, orchestrator shell script, and tests for both.
</objective>

<execution_context>
@/Users/jacob/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jacob/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gsd-coexistence/04-RESEARCH.md
@.planning/phases/03-statusline-provider/03-02-SUMMARY.md
@lib/statusline/format.js
@statusline.js
@statusline-test-wrapper.sh
@test/statusline.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add prefix support to formatExercise and update statusline.js</name>
  <files>lib/statusline/format.js, statusline.js, test/statusline.test.js</files>
  <action>
    1. Modify `formatExercise` in `lib/statusline/format.js` to accept an optional third parameter `options` (object with optional `prefix` string property). When `options.prefix` is provided, prepend it to the formatted output inside the ANSI codes. Keep the existing 2-argument signature working identically (backward compatible).

    Current signature: `formatExercise(name, reps)`
    New signature: `formatExercise(name, reps, options = {})`

    When prefix is provided:
    `${ANSI.cyan}${ANSI.bold}${prefix}${name} x${reps}${ANSI.reset}`

    When prefix is not provided (default empty string):
    `${ANSI.cyan}${ANSI.bold}${name} x${reps}${ANSI.reset}` (unchanged behavior)

    2. Update `statusline.js` to pass `{ prefix: '\ud83d\udcaa ' }` (flexed biceps emoji + space) as the third argument to `formatExercise` in the `result.type === 'exercise'` branch. This establishes VibeRipped's visual identity.

    3. Add tests to `test/statusline.test.js` in the `formatExercise` describe block:
    - Test that formatExercise with prefix option prepends prefix inside ANSI codes
    - Test that formatExercise without prefix option produces identical output to current behavior (regression)
    - Test that empty prefix string produces same output as no prefix

    4. Run `node --test test/statusline.test.js` to confirm all existing + new tests pass.
  </action>
  <verify>
    Run `node --test test/statusline.test.js` — all tests pass including new prefix tests.
    Run `echo '{"context_window":{"current_usage":{"input_tokens":100}}}' | VIBERIPPED_BYPASS_COOLDOWN=1 HOME=$(mktemp -d) node statusline.js` — output contains the flexed biceps emoji prefix.
  </verify>
  <done>formatExercise accepts optional prefix via options object. statusline.js passes flexed biceps prefix. All existing tests pass (no regressions). New prefix tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create orchestrator shell script with tests</name>
  <files>statusline-orchestrator.sh, test/orchestrator.test.js</files>
  <action>
    1. Create `statusline-orchestrator.sh` in the project root. This replaces the temporary `statusline-test-wrapper.sh` from Phase 3. The script must:

    ```bash
    #!/usr/bin/env bash
    set -euo pipefail

    # Resolve paths relative to this script's location
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

    # Provider paths: GSD from user's Claude hooks, VibeRipped from this project
    GSD_STATUSLINE="${GSD_STATUSLINE:-$HOME/.claude/hooks/gsd-statusline.js}"
    VR_STATUSLINE="${SCRIPT_DIR}/statusline.js"
    SEPARATOR="${VR_SEPARATOR:- \u2502 }"

    # Read stdin once into variable (stdin consumed only once)
    STDIN_DATA=$(cat)

    # Call each provider, suppress errors (one failing must not break the other)
    GSD_OUTPUT=""
    if [ -f "$GSD_STATUSLINE" ]; then
      GSD_OUTPUT=$(echo "$STDIN_DATA" | node "$GSD_STATUSLINE" 2>/dev/null || echo "")
    fi

    VR_OUTPUT=$(echo "$STDIN_DATA" | node "$VR_STATUSLINE" 2>/dev/null || echo "")

    # Conditional concatenation: no orphaned separators
    if [ -n "$GSD_OUTPUT" ] && [ -n "$VR_OUTPUT" ]; then
      printf "%s%s%s" "$GSD_OUTPUT" "$SEPARATOR" "$VR_OUTPUT"
    elif [ -n "$GSD_OUTPUT" ]; then
      printf "%s" "$GSD_OUTPUT"
    elif [ -n "$VR_OUTPUT" ]; then
      printf "%s" "$VR_OUTPUT"
    fi

    exit 0
    ```

    Key design choices:
    - Use `printf` not `echo` — avoids trailing newline (matches statusline.js behavior with process.stdout.write)
    - Use `$SEPARATOR` with Unicode box-drawing vertical line (\u2502 = "│") as default, configurable via VR_SEPARATOR env var
    - Check if GSD_STATUSLINE file exists before calling — graceful fallback when GSD not installed
    - Use `$HOME/.claude/hooks/gsd-statusline.js` as default GSD path (matches actual location on user's system)
    - `set -euo pipefail` for safety but each provider call uses `|| echo ""` to prevent cascade failures

    Make the script executable: `chmod +x statusline-orchestrator.sh`

    2. Create `test/orchestrator.test.js` using Node.js built-in test runner (same pattern as existing tests). Tests use `child_process.execSync` to invoke the orchestrator:

    Test cases:
    a. "orchestrator outputs both GSD and VibeRipped with separator when processing" — pipe valid processing JSON, verify output contains "│" separator and both provider outputs are present
    b. "orchestrator outputs only GSD when VibeRipped is silent (non-processing)" — pipe non-processing JSON (current_usage: null), verify output has GSD content but no separator
    c. "orchestrator outputs only VibeRipped when GSD_STATUSLINE points to nonexistent file" — set GSD_STATUSLINE env var to "/nonexistent/path", pipe processing JSON, verify VibeRipped output without separator
    d. "orchestrator exits 0 and produces no output when both providers silent" — set GSD_STATUSLINE to "/nonexistent/path" and pipe non-processing JSON, verify empty output and exit 0
    e. "orchestrator handles empty stdin gracefully" — pipe empty string, verify exit 0

    Use isolated HOME dirs (mkdtemp) for each test to prevent state interference (same pattern as statusline integration tests). Set VIBERIPPED_BYPASS_COOLDOWN=1 for deterministic exercise output.

    3. Delete the temporary `statusline-test-wrapper.sh` — it is superseded by the production orchestrator. Remove it with `fs.unlinkSync` or note for executor to delete.

    4. Run `node --test test/orchestrator.test.js` — all tests pass.
    5. Run `node --test` — full test suite passes (no regressions).
  </action>
  <verify>
    Run `node --test test/orchestrator.test.js` — all orchestrator tests pass.
    Run `node --test` — full test suite (all test files) passes.
    Run `echo '{"context_window":{"current_usage":{"input_tokens":100}}}' | VIBERIPPED_BYPASS_COOLDOWN=1 HOME=$(mktemp -d) bash statusline-orchestrator.sh` — output contains GSD portion and VibeRipped portion separated by "│".
    Verify `statusline-test-wrapper.sh` no longer exists.
  </verify>
  <done>statusline-orchestrator.sh created and executable. Orchestrator forwards stdin to both GSD and VibeRipped, concatenates with Unicode separator, handles failures gracefully. All orchestrator tests pass. Full test suite passes. Temporary test wrapper deleted.</done>
</task>

</tasks>

<verification>
1. `node --test` — full test suite passes (engine, config, pool, statusline, orchestrator)
2. `echo '{"context_window":{"current_usage":{"input_tokens":100}}}' | VIBERIPPED_BYPASS_COOLDOWN=1 HOME=$(mktemp -d) bash statusline-orchestrator.sh` — composite output with both providers
3. `echo '{"context_window":{"current_usage":null}}' | HOME=$(mktemp -d) bash statusline-orchestrator.sh` — GSD-only output (VibeRipped silent during non-processing)
4. `GSD_STATUSLINE=/nonexistent echo '{"context_window":{"current_usage":{"input_tokens":100}}}' | VIBERIPPED_BYPASS_COOLDOWN=1 HOME=$(mktemp -d) bash statusline-orchestrator.sh` — VibeRipped-only output (no separator)
5. `statusline-test-wrapper.sh` does not exist
</verification>

<success_criteria>
- formatExercise supports optional prefix via options parameter with full backward compatibility
- statusline.js outputs exercise prompts with flexed biceps emoji prefix for visual identity
- statusline-orchestrator.sh composes both providers with configurable separator
- One provider failing never breaks the other
- No orphaned separators when one provider is silent
- All tests pass (existing + new)
</success_criteria>

<output>
After completion, create `.planning/phases/04-gsd-coexistence/04-01-SUMMARY.md`
</output>
